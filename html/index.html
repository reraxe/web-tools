<!doctype html>
<html lang="en" data-theme="">
<head>
<meta charset="utf-8">
<title>WYSIWYG HTML Editor</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#f6f8fb; --bg-2:#eef3f9; --panel:#ffffff; --panel-2:#f2f6fb; --border:#d8e1ee;
    --text:#0b1220; --muted:#5b6b81; --accent:#2b6cff; --code-text:#0b1220;
    --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
    --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
    --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
    --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0f1216; --bg-2:#0c1016; --panel:#151a21; --panel-2:#1b2230; --border:#2a3442;
      --text:#e9eef6; --muted:#9db0c9; --accent:#6ea8ff; --code-text:#cfe4ff;
      --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
      --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
      --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
      --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
    }
  }
  /* Explicit overrides so toggle works */
  [data-theme="light"]{
    --bg:#f6f8fb; --bg-2:#eef3f9; --panel:#ffffff; --panel-2:#f2f6fb; --border:#d8e1ee;
    --text:#0b1220; --muted:#5b6b81; --accent:#2b6cff; --code-text:#0b1220;
    --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
    --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
    --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
    --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
  }
  [data-theme="dark"]{
    --bg:#0f1216; --bg-2:#0c1016; --panel:#151a21; --panel-2:#1b2230; --border:#2a3442;
    --text:#e9eef6; --muted:#9db0c9; --accent:#6ea8ff; --code-text:#cfe4ff;
    --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
    --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
    --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
    --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
  }

  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg) 60%,var(--bg-2));color:var(--text);
       font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";}
  header{padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel);
         display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:10}
  header h1{margin:0;margin-right:auto;font-size:16px;font-weight:700;color:var(--muted)}
  .theme-toggle{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);
                background:var(--panel-2);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer}
  .theme-toggle svg{width:16px;height:16px}

  .toolbar{display:flex;flex-wrap:wrap;gap:6px;background:var(--panel);padding:8px;border-bottom:1px solid var(--border);
           position:sticky;top:54px;z-index:9}
  .group{display:flex;gap:6px;padding-right:8px;border-right:1px solid var(--border)}
  .group:last-child{border:none;padding-right:0}
  button.tool, .btn{
    appearance:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);
    padding:8px 10px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
    transition:background .15s,border-color .15s,transform .02s;user-select:none
  }
  button.tool:hover,.btn:hover{background:var(--btn-hover);border-color:var(--btn-hover-b)}
  button.tool:active,.btn:active{transform:translateY(1px)}
  button.tool[aria-pressed="true"]{background:var(--btn-active);border-color:var(--btn-active-b)}
  button.tool svg{width:18px;height:18px;fill:currentColor}
  .tool--text .txt{font-weight:900;font-size:18px;letter-spacing:.2px}
  select.tool,input.tool{background:var(--panel-2);color:var(--text);border:1px solid var(--border);
                         border-radius:8px;padding:8px 10px;cursor:pointer}
  .color-wrap{display:flex;align-items:center;gap:6px}
  .hex-input{width:102px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--text);
             font-family:ui-monospace,monospace}
  input[type="color"].tool{appearance:none;width:36px;height:36px;padding:0;border:1px solid var(--border);border-radius:8px;background:var(--panel-2);cursor:pointer}
  input[type="color"].tool::-webkit-color-swatch-wrapper{padding:0}
  input[type="color"].tool::-webkit-color-swatch{border:none;border-radius:6px}
  input[type="color"].tool::-moz-color-swatch{border:none;border-radius:6px}

  .wrap{max-width:1100px;margin:18px auto;padding:0 14px 32px;display:grid;grid-template-columns:1fr 340px;gap:16px}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .card h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
  .editor{min-height:60vh;background:var(--panel-2);border:1px solid var(--border);border-radius:10px;
          padding:18px;outline:none;overflow:auto}
  .editor:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 15%,transparent),0 0 0 1px color-mix(in srgb,var(--accent) 25%,transparent)}
  .side{display:flex;flex-direction:column;gap:12px}
  textarea.code,textarea#notes{width:100%;min-height:220px;background:var(--panel-2);color:var(--code-text);
    border:1px dashed var(--border);border-radius:8px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .status{font-size:12px;color:var(--muted)}
  .pill{font-size:11px;padding:2px 8px;border:1px solid var(--border);background:var(--panel-2);color:var(--muted);border-radius:999px}

  dialog{border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);}
  dialog::backdrop{background:rgba(0,0,0,.4)}
  dialog h3{margin:0 0 8px}
  dialog label{display:block;margin:6px 0 8px}
  dialog input, dialog textarea, dialog button{font:inherit;color:var(--text)}
  dialog input, dialog textarea{width:100%;padding:8px 10px;background:var(--panel-2);border:1px solid var(--border);border-radius:8px}
  dialog menu{margin:12px 0 0;display:flex;gap:8px;justify-content:flex-end;padding:0}
  /* Wide source dialog */
  #sourceDialog{width:clamp(720px,92vw,1200px); max-width:none; padding:16px;}
  #sourceTextarea{min-height:60vh; font-family:ui-monospace,Menlo,Consolas,monospace}

  .toast{position:fixed;top:14px;right:14px;z-index:9999;background:var(--panel);border:1px solid var(--border);color:var(--text);
         padding:8px 12px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.18);opacity:0;transform:translateY(-6px);transition:.15s;pointer-events:none;font-size:13px}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<header>
  <h1>WYSIWYG HTML Editor</h1>
  <button id="themeBtn" class="theme-toggle" title="Theme: System">
    <svg id="themeIcon" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4v12a6 6 0 010-12z"/></svg>
    <span id="themeLabel">System</span>
  </button>
  <span class="pill" id="mainCount">0 chars</span>
  <span class="pill" title="Autosaves locally">Autosave: On</span>
</header>

<div class="toolbar" role="toolbar" aria-label="Editor toolbar" id="toolbar">
  <div class="group">
    <select id="blockFormat" class="tool" title="Paragraph / Heading">
      <option value="p" selected>Paragraph</option>
      <option value="h1">Heading 1</option>
      <option value="h2">Heading 2</option>
      <option value="h3">Heading 3</option>
      <option value="blockquote">Blockquote</option>
      <option value="pre">Code Block</option>
    </select>
    <button class="tool tool--text" data-cmd="bold" aria-label="Bold"><span class="txt">B</span></button>
    <button class="tool" data-cmd="italic" aria-label="Italic"><svg viewBox="0 0 24 24"><path d="M10 5v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V5z"/></svg></button>
    <button class="tool" data-cmd="underline" aria-label="Underline"><svg viewBox="0 0 24 24"><path d="M12 17a5 5 0 0 0 5-5V5h-3v7a2 2 0 0 1-4 0V5H7v7a5 5 0 0 0 5 5zm-7 2v2h14v-2H5z"/></svg></button>
    <button class="tool" data-cmd="superscript" aria-label="Superscript"><svg viewBox="0 0 24 24"><path d="M5 7h3l3 4 3-4h3l-4.5 6L17 19h-3l-3-4-3 4H5l4.5-6L5 7zm14.5 0H23v1.5h-2.1c.9.5 1.6 1.4 1.6 2.5 0 1.7-1.4 3-3 3-.9 0-1.7-.4-2.2-1l1.2-1.1c.3.3.6.4 1 .4.6 0 1-.4 1-1s-.4-1-1-1H18V7h1.5z"/></svg></button>
    <button class="tool" id="clearFormatBtn" title="Clear format"><svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm3 4h8v2H6v-2zm0 4h12v2H6v-2zm0 4h6v2H6v-2zM17 3l4 4-8 8-4 1 1-4 8-8z"/></svg></button>
  </div>

  <div class="group">
    <button class="tool" data-cmd="justifyLeft" aria-label="Align Left"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h12v2H3zM3 13h18v2H3zM3 17h12v2H3z"/></svg></button>
    <button class="tool" data-cmd="justifyCenter" aria-label="Align Center"><svg viewBox="0 0 24 24"><path d="M6 5h12v2H6zM3 9h18v2H3zM6 13h12v2H6zM3 17h18v2H3z"/></svg></button>
    <button class="tool" data-cmd="justifyRight" aria-label="Align Right"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM9 9h12v2H9zM3 13h18v2H3zM9 17h12v2H9z"/></svg></button>
    <button class="tool" data-cmd="justifyFull" aria-label="Justify"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h18v2H3zM3 13h18v2H3zM3 17h18v2H3z"/></svg></button>
  </div>

  <div class="group">
    <button class="tool" data-cmd="insertUnorderedList" aria-label="Bulleted List"><svg viewBox="0 0 24 24"><path d="M7 5h14v2H7zM3 5h2v2H3zM7 11h14v2H7zM3 11h2v2H3zM7 17h14v2H7zM3 17h2v2H3z"/></svg></button>
    <button class="tool" data-cmd="insertOrderedList" aria-label="Numbered List"><svg viewBox="0 0 24 24"><path d="M7 5h14v2H7zM3 5h2v2H3zM7 11h14v2H7zM3 10h2v4H3zM7 17h14v2H7zM3 16h3v2H3z"/></svg></button>
    <button class="tool" data-cmd="outdent" aria-label="Outdent"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h10v2H3zM3 13h18v2H3zM3 17h10v2H3zM11 8l-4 4 4 4V8z"/></svg></button>
    <button class="tool" data-cmd="indent" aria-label="Indent"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h10v2H3zM3 13h18v2H3zM3 17h10v2H3zM13 8v8l4-4-4-4z"/></svg></button>
  </div>

  <div class="group">
    <button class="tool" id="linkBtn" aria-label="Insert Link"><svg viewBox="0 0 24 24"><path d="M3.9 12a5.1 5.1 0 0 1 5.1-5.1h3V9h-3a3 3 0 1 0 0 6h3v2.1h-3A5.1 5.1 0 0 1 3.9 12zm11.1-3V6.9h3A5.1 5.1 0 0 1 23.1 12 5.1 5.1 0 0 1 18 17.1h-3V15h3a3 3 0 1 0 0-6h-3zM10 11h4v2h-4z"/></svg></button>
    <button class="tool" id="emailBtn" aria-label="Insert Email Link"><svg viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></button>
    <button class="tool" id="imageBtn" aria-label="Insert Image"><svg viewBox="0 0 24 24"><path d="M19 4H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 13H4V7h16v10zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-3 8l4-5 3 4 3-4 5 5H5z"/></svg></button>
    <input type="file" id="imageFile" accept="image/*" style="display:none">
    <button class="tool" data-cmd="undo" aria-label="Undo"><svg viewBox="0 0 24 24"><path d="M12 6a7 7 0 0 0-7 7H2l4 4 4-4H7a5 5 0 0 1 8.5-3.5l1.4-1.4A7 7 0 0 0 12 6z"/></svg></button>
    <button class="tool" data-cmd="redo" aria-label="Redo"><svg viewBox="0 0 24 24"><path d="M12 6a7 7 0 0 1 7 7h3l-4 4-4-4h3a5 5 0 0 0-8.5-3.5L6.1 8.1A7 7 0 0 1 12 6z"/></svg></button>
  </div>

  <div class="group">
    <label class="status">Text</label>
    <div class="color-wrap">
      <input class="tool" id="foreColor" type="color" value="#0b1220" title="Text color">
      <input id="foreHex" class="hex-input" value="#0b1220" aria-label="Text HEX">
    </div>
    <label class="status">Bg</label>
    <div class="color-wrap">
      <input class="tool" id="backColor" type="color" value="#fff4a3" title="Highlight color">
      <input id="backHex" class="hex-input" value="#fff4a3" aria-label="Background HEX">
    </div>
  </div>

  <div class="group">
    <button class="tool" id="cleanBtn" title="Clean"><svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm2 4h14l-1.5 10h-11L5 10zm6-6h2v2h-2V4z"/></svg>Clean</button>
    <button class="tool" id="copyBtn" title="Copy HTML"><svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z"/></svg>Copy</button>
    <button class="tool" id="downloadBtn" title="Download"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM11 4h2v8h3l-4 4-4-4h3z"/></svg>Download</button>
    <button class="tool" id="clearBtn" title="Clear document"><svg viewBox="0 0 24 24"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>New</button>
    <button class="tool" id="sourceBtn" title="Edit full source"><svg viewBox="0 0 24 24"><path d="M8 5l-6 7 6 7 1.5-1.3L4.9 12 9.5 6.3 8 5zm8 0l-1.5 1.3L19.1 12l-4.6 5.7L16 19l6-7-6-7z"/></svg>Source</button>
  </div>
</div>

<div class="wrap">
  <div>
    <div class="card">
      <div id="editor" class="editor" contenteditable="true" role="textbox" aria-multiline="true" spellcheck="true">
        <h1>Welcome 👋</h1>
        <p>This editor uses <code>&lt;p&gt;</code> for new lines. Press Enter.</p>
        <ul>
          <li>Open “Source” to edit the full HTML in a popup.</li>
          <li>Right panel is read-only and updates automatically.</li>
          <li>Autosaves locally.</li>
        </ul>
      </div>
    </div>
  </div>

  <aside class="side">
    <div class="card">
      <h3>HTML Source (one element per line)</h3>
      <textarea id="code" class="code" aria-label="HTML source (read-only)" readonly></textarea>
      <div class="status" id="charCount">0 chars</div>
    </div>
    <div class="card">
      <h3>Notepad (free text)</h3>
      <textarea id="notes" placeholder="Write anything here… (not linked to the code)"></textarea>
    </div>
  </aside>
</div>

<!-- Link dialog -->
<dialog id="linkDialog">
  <form method="dialog" novalidate>
    <h3>Insert Link</h3>
    <label>Text <input type="text" id="linkText" placeholder="Link text"></label>
    <label>URL  <input type="url" id="linkUrl" placeholder="https://example.com"></label>
    <label><input type="checkbox" id="linkBlank" checked> Open in new tab</label>
    <menu>
      <button value="cancel" formnovalidate>Cancel</button>
      <button id="linkApply" value="default">Insert</button>
    </menu>
  </form>
</dialog>

<!-- Email dialog -->
<dialog id="emailDialog">
  <form method="dialog" novalidate>
    <h3>Insert Email Link</h3>
    <label>Text <input type="text" id="emailText" placeholder="Email link text"></label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Email   <input type="email" id="emailAddr" placeholder="name@example.com"></label>
      <label>Subject <input type="text" id="emailSubject" placeholder="Subject line"></label>
    </div>
    <menu>
      <button value="cancel" formnovalidate>Cancel</button>
      <button id="emailApply" value="default">Insert</button>
    </menu>
  </form>
</dialog>

<!-- Image dialog -->
<dialog id="imageDialog">
  <form method="dialog" novalidate>
    <h3>Insert Image</h3>
    <label>Image URL <input type="url" id="imageUrl" placeholder="https://..."></label>
    <div style="display:flex;gap:8px;align-items:center;margin:10px 0">
      <span class="status">or</span>
      <button id="chooseFileBtn" type="button" class="btn">Choose File…</button>
      <input type="file" id="imageFile2" accept="image/*" style="display:none">
    </div>
    <label>Alt text <input type="text" id="imageAlt" placeholder="Describe the image"></label>
    <menu>
      <button value="cancel" formnovalidate>Cancel</button>
      <button id="imageApply" value="default">Insert</button>
    </menu>
  </form>
</dialog>

<!-- SOURCE POPUP (wide, editable) -->
<dialog id="sourceDialog">
  <form method="dialog">
    <h3>Edit Full HTML</h3>
    <textarea id="sourceTextarea" spellcheck="false"></textarea>
    <menu>
      <button value="cancel">Cancel</button>
      <button id="sourceApplyBtn" value="default">Apply</button>
    </menu>
  </form>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite">Copied!</div>

<script>
/* THEME (System default + working toggle) */
const root=document.documentElement, themeBtn=document.getElementById('themeBtn'),
      themeLabel=document.getElementById('themeLabel'), themeIcon=document.getElementById('themeIcon');
const THEME_KEY='wysiwys-theme';
function setIcon(kind){
  themeIcon.innerHTML = kind==='moon'
    ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>'
    : kind==='sun'
    ? '<path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM12 4V1h0v3h0zm5.24.84l1.79-1.8 1.41 1.41-1.8 1.79-1.4-1.4zM4 12H1v0h3v0zm19 0h-3v0h3v0zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zM20.45 18.36l1.41 1.41-1.79 1.79-1.4-1.4 1.78-1.8zM12 23v-3h0v3h0zM12 7a5 5 0 100 10 5 5 0 000-10z"/>'
    : '<path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4v12a6 6 0 010-12z"/>';
}
function applyTheme(mode){
  if(mode==='light'){ root.setAttribute('data-theme','light'); themeLabel.textContent='Light'; setIcon('sun'); }
  else if(mode==='dark'){ root.setAttribute('data-theme','dark'); themeLabel.textContent='Dark'; setIcon('moon'); }
  else { root.setAttribute('data-theme',''); themeLabel.textContent='System'; setIcon('auto'); }
  try{ localStorage.setItem(THEME_KEY,mode); }catch{}
}
function nextTheme(m){ return m==='system'?'light':m==='light'?'dark':'system'; }
(function initTheme(){
  let saved='system'; try{ saved=localStorage.getItem(THEME_KEY)||'system'; }catch{}
  applyTheme(saved);
  const mq=window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener?.('change', ()=>{ if ((localStorage.getItem(THEME_KEY)||'system')==='system') applyTheme('system'); });
})();
themeBtn.addEventListener('click', ()=>{ const cur=localStorage.getItem(THEME_KEY)||'system'; applyTheme(nextTheme(cur)); });

/* Elements */
const editor=document.getElementById('editor'),
      codeArea=document.getElementById('code'),
      charCount=document.getElementById('charCount'),
      mainCount=document.getElementById('mainCount'),
      notes=document.getElementById('notes'),
      toast=document.getElementById('toast');

/* Paragraph behavior */
document.execCommand('defaultParagraphSeparator', false, 'p');
const INLINE_OK=new Set(['BR','IMG','A','SPAN','STRONG','EM','B','I','U','S','SMALL','SUP','SUB','CODE','KBD','MARK','TIME']);
function wrapTopTextInParagraph(container){
  [...container.childNodes].forEach(node=>{
    if(node.nodeType===3 && node.nodeValue.trim()){
      const p=document.createElement('p'); p.textContent=node.nodeValue; node.replaceWith(p);
    }
  });
}
function ensureBaseline(){ if(editor.textContent.replace(/\u200B/g,'').trim()===''){ editor.innerHTML='<p></p>'; } }
function removeTrailingEmptyParagraph(rootEl){
  const kids=[...rootEl.children]; if(!kids.length){ ensureBaseline(); return; }
  const last=kids[kids.length-1];
  if(last.tagName==='P'){
    const html=last.innerHTML.replace(/\s+/g,'').toLowerCase();
    if(html===''||html==='<br>'||html==='<br/>'||html==='<br/>'){ if(kids.length>1) last.remove(); }
  }
  ensureBaseline();
}
function normalizeDivsToParagraphs(rootEl){
  rootEl.querySelectorAll('div').forEach(div=>{
    const hasBlocks=[...div.children].some(c=>c.nodeType===1 && !INLINE_OK.has(c.tagName));
    if(!hasBlocks){ const p=document.createElement('p'); while(div.firstChild) p.appendChild(div.firstChild); div.replaceWith(p); }
  });
  wrapTopTextInParagraph(rootEl);
  removeTrailingEmptyParagraph(rootEl);
}

/* Serialize (one element per line) */
const VOID=new Set(['AREA','BASE','BR','COL','EMBED','HR','IMG','INPUT','LINK','META','PARAM','SOURCE','TRACK','WBR']);
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function attrs(el){return Array.from(el.attributes).map(a=>` ${a.name}="${a.value.replace(/"/g,'&quot;')}"`).join('');}
function serializeOneLine(rootEl){
  const lines=[];
  function visit(node){
    if(node.nodeType===1){
      const el=node; const tag=el.tagName.toLowerCase();
      if(VOID.has(el.tagName)){ lines.push(`<${tag}${attrs(el)}/>`); return; }
      if(tag==='ul'||tag==='ol'){
        lines.push(`<${tag}${attrs(el)}>`); Array.from(el.children).forEach(li=>{ if(li.tagName==='LI'){ lines.push(`<li>${li.innerHTML.trim()}</li>`); } }); lines.push(`</${tag}>`); return;
      }
      const children=Array.from(el.childNodes);
      if(children.every(c=>c.nodeType!==1)){ const text=el.textContent??''; lines.push(`<${tag}${attrs(el)}>${esc(text)}</${tag}>`); }
      else { lines.push(`<${tag}${attrs(el)}>`); children.forEach(c=>{ if(c.nodeType===1) visit(c); else if(c.nodeType===3){ const t=c.nodeValue.trim(); if(t) lines.push(esc(t)); } }); lines.push(`</${tag}>`); }
    } else if(node.nodeType===3){ const t=node.nodeValue.trim(); if(t) lines.push(esc(t)); }
  }
  if(rootEl.childNodes.length===0) return '<p></p>';
  Array.from(rootEl.childNodes).forEach(visit);
  const out=lines.join('\n').trim();
  return out||'<p></p>';
}
function updateCodeFromEditor(){
  const oneLine=serializeOneLine(editor);
  codeArea.value=oneLine;
  charCount.textContent=oneLine.length.toLocaleString()+' chars';
  mainCount.textContent=(editor.innerText||'').length.toLocaleString()+' chars';
}

/* Exec + toolbar */
function exec(cmd,val=null){
  document.execCommand(cmd,false,val);
  editor.focus();
  normalizeDivsToParagraphs(editor);
  save(); updateCodeFromEditor();
}
document.getElementById('blockFormat').addEventListener('change',e=>{
  const tag=e.target.value; document.execCommand('formatBlock', false, `<${tag}>`);
  normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
});
document.getElementById('toolbar').addEventListener('click',e=>{
  const btn=e.target.closest('button.tool'); if(!btn) return;
  const cmd=btn.dataset.cmd; if(cmd){ e.preventDefault(); exec(cmd); }
});

/* Clear format */
function replaceTag(el,newTag){ const n=document.createElement(newTag); while(el.firstChild)n.appendChild(el.firstChild); el.replaceWith(n); return n; }
function blocksInSelection(){
  const sel=window.getSelection(); if(!sel.rangeCount) return [];
  const r=sel.getRangeAt(0); const c=r.commonAncestorContainer.nodeType===1?r.commonAncestorContainer:r.commonAncestorContainer.parentElement;
  const out=[]; c.querySelectorAll('*').forEach(n=>{ if(r.intersectsNode(n)&&/^(P|H1|H2|H3|H4|H5|H6|BLOCKQUOTE|PRE)$/.test(n.tagName)) out.push(n); });
  if(!out.length){ const start=r.startContainer.nodeType===1?r.startContainer:r.startContainer.parentElement; const b=start.closest('p,h1,h2,h3,h4,h5,h6,blockquote,pre'); if(b) out.push(b); }
  return out;
}
document.getElementById('clearFormatBtn').addEventListener('click',()=>{
  document.execCommand('removeFormat'); document.execCommand('unlink');
  blocksInSelection().forEach(b=>{ if(/^H[1-6]$/.test(b.tagName)||b.tagName==='BLOCKQUOTE'||b.tagName==='PRE') replaceTag(b,'p'); });
  editor.querySelectorAll('[style]').forEach(n=>n.removeAttribute('style'));
  normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
});

/* Enter handling */
editor.addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){
    const node=(window.getSelection().anchorNode||editor);
    const el=node.nodeType===1?node:node.parentElement;
    if(el && el.closest('pre')) return;
    e.preventDefault();
    document.execCommand('insertParagraph'); normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
  }
});
editor.addEventListener('input',()=>{ normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor(); });
editor.addEventListener('paste',e=>{ e.preventDefault(); const text=(e.clipboardData||window.clipboardData).getData('text/plain'); document.execCommand('insertText',false,text); normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor(); });

/* Link / Email */
let savedRange=null;
function saveSel(){const s=window.getSelection(); if(s.rangeCount) savedRange=s.getRangeAt(0);}
function restoreSel(){ if(!savedRange) return; const s=window.getSelection(); s.removeAllRanges(); s.addRange(savedRange); }
function insertLinkOrWrap(href,text,blank){
  restoreSel(); const s=window.getSelection(); if(!s.rangeCount) return; const r=s.getRangeAt(0);
  const attrs=(!href.startsWith('mailto:')&&blank)?' target="_blank" rel="noopener noreferrer"':'';
  const safeHref=href.replace(/"/g,'&quot;'), safeText=(text||href).replace(/</g,'&lt;').replace(/>/g,'&gt;');
  if(s.isCollapsed){ document.execCommand('insertHTML',false,`<a href="${safeHref}"${attrs}>${safeText}</a>`); }
  else{ try{ const a=document.createElement('a'); a.setAttribute('href',href); if(attrs){a.setAttribute('target','_blank');a.setAttribute('rel','noopener noreferrer');} r.surroundContents(a); }
        catch{ const div=document.createElement('div'); div.appendChild(r.cloneContents()); document.execCommand('insertHTML',false,`<a href="${safeHref}"${attrs}>${div.innerHTML}</a>`); } }
  normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
}
const linkDialog=document.getElementById('linkDialog');
document.getElementById('linkBtn').addEventListener('click',()=>{saveSel(); const s=window.getSelection(); document.getElementById('linkText').value=s&&s.toString()?s.toString():''; document.getElementById('linkUrl').value=''; document.getElementById('linkBlank').checked=true; linkDialog.showModal();});
document.getElementById('linkApply').addEventListener('click',()=>{const t=document.getElementById('linkText').value.trim(); const u=document.getElementById('linkUrl').value.trim(); const b=document.getElementById('linkBlank').checked; if(!u){linkDialog.close();return;} insertLinkOrWrap(u,t,b); linkDialog.close();});

const emailDialog=document.getElementById('emailDialog');
document.getElementById('emailBtn').addEventListener('click',()=>{saveSel(); const s=window.getSelection(); document.getElementById('emailText').value=s&&s.toString()?s.toString():''; document.getElementById('emailAddr').value=''; document.getElementById('emailSubject').value=''; emailDialog.showModal();});
document.getElementById('emailApply').addEventListener('click',()=>{const t=document.getElementById('emailText').value.trim(); const eaddr=document.getElementById('emailAddr').value.trim(); const sub=document.getElementById('emailSubject').value.trim(); if(!eaddr){emailDialog.close();return;} const href=`mailto:${eaddr}${sub?`?subject=${encodeURIComponent(sub)}`:''}`; insertLinkOrWrap(href,t,false); emailDialog.close();});

/* Images */
const imageDialog=document.getElementById('imageDialog');
document.getElementById('imageBtn').addEventListener('click',()=>{saveSel(); document.getElementById('imageUrl').value=''; document.getElementById('imageAlt').value=''; imageDialog.showModal();});
document.getElementById('chooseFileBtn').addEventListener('click',()=>document.getElementById('imageFile2').click());
document.getElementById('imageFile2').addEventListener('change',handleImageFile);
document.getElementById('imageFile').addEventListener('change',handleImageFile);
document.getElementById('imageApply').addEventListener('click',()=>{restoreSel(); const url=document.getElementById('imageUrl').value.trim(); const alt=document.getElementById('imageAlt').value.trim(); if(url){ exec('insertImage',url); const imgs=editor.querySelectorAll('img'); if(imgs.length){const img=imgs[imgs.length-1]; if(alt) img.alt=alt; img.style.maxWidth='100%'; img.style.height='auto'; }} imageDialog.close();});
function handleImageFile(e){const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{restoreSel(); exec('insertImage',r.result);}; r.readAsDataURL(f); imageDialog.close(); e.target.value='';}
['dragenter','dragover','dragleave','drop'].forEach(ev=>{editor.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();});});
editor.addEventListener('drop',e=>{const files=e.dataTransfer.files; if(files&&files.length){[...files].forEach(f=>{if(f.type.startsWith('image/')){const r=new FileReader(); r.onload=()=>exec('insertImage',r.result); r.readAsDataURL(f);}});} else {const url=e.dataTransfer.getData('text/uri-list')||e.dataTransfer.getData('text/plain'); if(url) exec('insertImage',url);} });

/* Clean / Copy / Download / Clear */
function cleanHTML(html){
  const tmp=document.createElement('div'); tmp.innerHTML=html;
  tmp.querySelectorAll('script,style,iframe,object,embed,link,meta').forEach(n=>n.remove());
  tmp.querySelectorAll('*').forEach(el=>{[...el.attributes].forEach(a=>{ if(/^on/i.test(a.name)) el.removeAttribute(a.name); if((a.name==='href'||a.name==='src') && /^\s*javascript:/i.test(a.value)) el.removeAttribute(a.name); });});
  normalizeDivsToParagraphs(tmp); return tmp.innerHTML;
}
document.getElementById('cleanBtn').addEventListener('click',()=>{editor.innerHTML=cleanHTML(editor.innerHTML); save(); updateCodeFromEditor();});
function showToast(msg){toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200);}
document.getElementById('copyBtn').addEventListener('click',async()=>{try{await navigator.clipboard.writeText(codeArea.value); showToast('HTML copied');}catch{codeArea.removeAttribute('readonly'); codeArea.select(); document.execCommand('copy'); codeArea.setAttribute('readonly',''); showToast('HTML copied');}});
document.getElementById('downloadBtn').addEventListener('click',()=>{const blob=new Blob([`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Exported</title></head><body>${editor.innerHTML}</body></html>`],{type:'text/html;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='document.html'; a.click(); URL.revokeObjectURL(a.href);});
document.getElementById('clearBtn').addEventListener('click',()=>{editor.innerHTML='<p></p>'; save(); updateCodeFromEditor();});

/* Source popup (wide) */
const sourceBtn=document.getElementById('sourceBtn'), sourceDialog=document.getElementById('sourceDialog'), sourceTextarea=document.getElementById('sourceTextarea'), sourceApplyBtn=document.getElementById('sourceApplyBtn');
sourceBtn.addEventListener('click',()=>{sourceTextarea.value=editor.innerHTML; sourceDialog.showModal();});
sourceApplyBtn.addEventListener('click',()=>{ editor.innerHTML=cleanHTML(sourceTextarea.value); normalizeDivsToParagraphs(editor); updateCodeFromEditor(); save(); sourceDialog.close(); });
sourceTextarea.addEventListener('keydown',e=>e.stopPropagation());

/* HEX-first UX: clicking color swatch auto-focuses HEX field */
const foreColorEl=document.getElementById('foreColor'), backColorEl=document.getElementById('backColor'),
      foreHexEl=document.getElementById('foreHex'), backHexEl=document.getElementById('backHex');
function toHex(v){v=v.trim(); if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)) return v.length===4?('#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3]).toLowerCase():v.toLowerCase(); return null;}
foreColorEl.addEventListener('input',e=>{const v=e.target.value; foreHexEl.value=v; exec('foreColor',v);});
backColorEl.addEventListener('input',e=>{const v=e.target.value; backHexEl.value=v; exec('hiliteColor',v);});
foreHexEl.addEventListener('change',e=>{const v=toHex(e.target.value)||foreColorEl.value; foreHexEl.value=v; foreColorEl.value=v; exec('foreColor',v);});
backHexEl.addEventListener('change',e=>{const v=toHex(e.target.value)||backColorEl.value; backHexEl.value=v; backColorEl.value=v; exec('hiliteColor',v);});
[foreColorEl, backColorEl].forEach((el,i)=>{ el.addEventListener('click', ()=>{ const hex=i===0?foreHexEl:backHexEl; setTimeout(()=>{ hex.focus(); hex.select(); }, 0); }); });

/* Autosave & observe */
const LS_DOC='wysiwys-doc-v14', LS_NOTES='wysiwys-notes-v1';
function save(){ try{localStorage.setItem(LS_DOC, editor.innerHTML);}catch{} }
function load(){
  try{ const d=localStorage.getItem(LS_DOC); if(d) editor.innerHTML=d; }catch{}
  normalizeDivsToParagraphs(editor);
  try{ const n=localStorage.getItem(LS_NOTES); if(n!=null) notes.value=n; }catch{}
}
notes.addEventListener('input',()=>{try{localStorage.setItem(LS_NOTES,notes.value);}catch{}});
const obs=new MutationObserver(()=>{ updateCodeFromEditor(); save(); });
obs.observe(editor,{subtree:true,childList:true,characterData:true});

/* Init */
load(); updateCodeFromEditor();

/* Active states */
function refreshActiveStates(){
  const map={bold:'bold',italic:'italic',underline:'underline',superscript:'superscript'};
  document.querySelectorAll('button.tool[data-cmd]').forEach(btn=>{
    const cmd=btn.dataset.cmd; if(map[cmd]) btn.setAttribute('aria-pressed', document.queryCommandState(cmd) ? 'true' : 'false');
  });
}
setInterval(refreshActiveStates,300);
</script>
</body>
</html>
