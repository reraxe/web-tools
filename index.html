<!doctype html>
<html lang="en" data-theme="">
<head>
  <meta charset="utf-8" />
  <title>WYSIWYG HTML Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f6f8fb; --bg-2:#eef3f9; --panel:#ffffff; --panel-2:#f2f6fb; --border:#d8e1ee;
      --text:#0b1220; --muted:#5b6b81; --accent:#2b6cff; --accent-2:#16a34a; --danger:#dc2626; --code-text:#0b1220;
      --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
      --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
      --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
      --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1216; --bg-2:#0c1016; --panel:#151a21; --panel-2:#1b2230; --border:#2a3442;
        --text:#e9eef6; --muted:#9db0c9; --accent:#6ea8ff; --accent-2:#7bd389; --danger:#ff6b6b; --code-text:#cfe4ff;
        --btn-hover: color-mix(in srgb, var(--panel-2) 85%, var(--accent) 15%);
        --btn-hover-b: color-mix(in srgb, var(--border) 60%, var(--accent) 40%);
        --btn-active: color-mix(in srgb, var(--panel-2) 65%, var(--accent) 35%);
        --btn-active-b: color-mix(in srgb, var(--border) 40%, var(--accent) 60%);
      }
    }
    [data-theme="light"]{ /* same as :root light */ }
    [data-theme="dark"]{  /* same as dark above */ }

    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg), var(--bg) 60%, var(--bg-2));
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      color-scheme: light dark;
    }
    header{
      padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel);
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:10;
    }
    header h1{margin:0;margin-right:auto;font-size:16px;font-weight:700;color:var(--muted);}
    .toolbar{
      display:flex;flex-wrap:wrap;gap:6px;background:var(--panel);padding:8px;border-bottom:1px solid var(--border);
      position:sticky;top:54px;z-index:9;
    }
    .group{display:flex;gap:6px;padding-right:8px;border-right:1px solid var(--border)}
    .group:last-child{border:none;padding-right:0}
    button.tool{
      appearance:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);
      padding:8px 10px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      transition:background .15s,border-color .15s,transform .02s;user-select:none;
    }
    button.tool:hover{background:var(--btn-hover);border-color:var(--btn-hover-b)}
    button.tool:active{transform:translateY(1px)}
    button.tool[aria-pressed="true"]{background:var(--btn-active);border-color:var(--btn-active-b)}
    button.tool svg{width:18px;height:18px;fill:currentColor}
    .tool--text .txt{font-weight:900;font-size:18px;letter-spacing:.2px}
    select.tool, input.tool{
      background:var(--panel-2);color:var(--text);border:1px solid var(--border);
      border-radius:8px;padding:8px 10px;cursor:pointer
    }
    .color-wrap{display:flex;align-items:center;gap:6px}
    .hex-input{
      width:90px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;
      background:var(--panel);color:var(--text);font-family:ui-monospace,monospace
    }
    input[type="color"].tool{
      -webkit-appearance:none;appearance:none;width:36px;height:36px;padding:0;
      border:1px solid var(--border);border-radius:8px;background:var(--panel-2);cursor:pointer;
    }
    input[type="color"].tool::-webkit-color-swatch-wrapper{padding:0}
    input[type="color"].tool::-webkit-color-swatch{border:none;border-radius:6px}
    input[type="color"].tool::-moz-color-swatch{border:none;border-radius:6px}
    input[type="color"].tool:hover{background:var(--btn-hover);border-color:var(--btn-hover-b)}

    .wrap{
      max-width:1100px;margin:18px auto;padding:0 14px 32px;
      display:grid;grid-template-columns:1fr 340px;gap:16px;
    }
    @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .card h3{margin:0 0 8px;font-size:14px;color:var(--muted)}

    .editor{
      min-height:60vh;background:var(--panel-2);border:1px solid var(--border);
      border-radius:10px;padding:18px;outline:none;overflow:auto;
    }
    .editor:focus{box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 15%, transparent), 0 0 0 1px color-mix(in srgb, var(--accent) 25%, transparent)}
    .side{display:flex;flex-direction:column;gap:12px;}

    textarea.code, textarea#notes{
      width:100%;min-height:220px;background:var(--panel-2);color:var(--code-text);
      border:1px dashed var(--border);border-radius:8px;padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px
    }
    .status{font-size:12px;color:var(--muted)}
    .pill{font-size:11px;padding:2px 8px;border:1px solid var(--border);
      background:var(--panel-2);color:var(--muted);border-radius:999px}

    .theme-toggle{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
      background:var(--panel-2);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;
    }
    .theme-toggle svg{width:16px;height:16px}

    dialog{
      border:1px solid var(--border); border-radius:10px; padding:16px 16px 12px;
      background:var(--panel); color:var(--text); max-width:520px;
    }
    dialog::backdrop{ background: rgba(0,0,0,.4); }
    dialog form h3{ margin:0 0 10px; color:var(--text); }
    dialog label{display:block;margin-bottom:8px}
    dialog input, dialog button{ font:inherit; color:var(--text); }
    dialog input{
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border);
      background:var(--panel-2); margin-top:4px;
    }
    dialog .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    dialog menu{ margin:14px 0 0; padding:0; }
    dialog button{
      appearance:none; border:1px solid var(--border); background:var(--panel-2);
      padding:8px 12px; border-radius:8px; cursor:pointer;
    }
    dialog button:hover{ background:var(--btn-hover); border-color:var(--btn-hover-b); }

    .toast{
      position:fixed; top:14px; right:14px; z-index:9999;
      background:var(--panel); border:1px solid var(--border); color:var(--text);
      padding:8px 12px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.18);
      opacity:0; transform:translateY(-6px); transition:opacity .15s, transform .15s;
      pointer-events:none; font-size:13px;
    }
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header>
    <h1>WYSIWYG HTML Editor</h1>
    <button id="themeBtn" class="theme-toggle" title="Theme: System">
      <svg id="themeIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 14.32l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 4V1h-0v3h0zm0 19v-3h0v3h0zM4 12H1v0h3v0zm19 0h-3v0h3v0zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zM20.45 5.64l-1.41-1.41-1.79 1.79 1.4 1.4 1.8-1.78zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
      <span id="themeLabel">System</span>
    </button>
    <span class="pill" id="mainCount">0 chars</span>
    <span class="pill" title="Autosaves locally">Autosave: On</span>
  </header>

  <!-- TOOLBAR -->
  <div class="toolbar" role="toolbar" aria-label="Editor toolbar">
    <div class="group">
      <select id="blockFormat" class="tool" title="Paragraph / Heading">
        <option value="p" selected>Paragraph</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="h3">Heading 3</option>
        <option value="blockquote">Blockquote</option>
        <option value="pre">Code Block</option>
      </select>
      <button class="tool tool--text" data-cmd="bold" aria-label="Bold (Ctrl/Cmd+B)"><span class="txt">B</span></button>
      <button class="tool" data-cmd="italic" aria-label="Italic (Ctrl/Cmd+I)"><svg viewBox="0 0 24 24"><path d="M10 5v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V5z"/></svg></button>
      <button class="tool" data-cmd="underline" aria-label="Underline (Ctrl/Cmd+U)"><svg viewBox="0 0 24 24"><path d="M12 17a5 5 0 0 0 5-5V5h-3v7a2 2 0 0 1-4 0V5H7v7a5 5 0 0 0 5 5zm-7 2v2h14v-2H5z"/></svg></button>
      <!-- Superscript -->
      <button class="tool" data-cmd="superscript" aria-label="Superscript">
        <svg viewBox="0 0 24 24"><path d="M5 7h3l3 4 3-4h3l-4.5 6L17 19h-3l-3-4-3 4H5l4.5-6L5 7zm14.5 0H23v1.5h-2.1c.9.5 1.6 1.4 1.6 2.5 0 1.7-1.4 3-3 3-.9 0-1.7-.4-2.2-1l1.2-1.1c.3.3.6.4 1 .4.6 0 1-.4 1-1s-.4-1-1-1H18V7h1.5z"/></svg>
      </button>
      <!-- Clear format -->
      <button class="tool" id="clearFormatBtn" title="Clear format (remove styles, headings, links)">
        <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm3 4h8v2H6v-2zm0 4h12v2H6v-2zm0 4h6v2H6v-2zM17 3l4 4-8 8-4 1 1-4 8-8z"/></svg>
      </button>
    </div>

    <div class="group">
      <button class="tool" data-cmd="justifyLeft" aria-label="Align Left"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h12v2H3zM3 13h18v2H3zM3 17h12v2H3z"/></svg></button>
      <button class="tool" data-cmd="justifyCenter" aria-label="Align Center"><svg viewBox="0 0 24 24"><path d="M6 5h12v2H6zM3 9h18v2H3zM6 13h12v2H6zM3 17h18v2H3z"/></svg></button>
      <button class="tool" data-cmd="justifyRight" aria-label="Align Right"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM9 9h12v2H9zM3 13h18v2H3zM9 17h12v2H9z"/></svg></button>
      <button class="tool" data-cmd="justifyFull" aria-label="Justify"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h18v2H3zM3 13h18v2H3zM3 17h18v2H3z"/></svg></button>
    </div>

    <div class="group">
      <button class="tool" data-cmd="insertUnorderedList" aria-label="Bulleted List"><svg viewBox="0 0 24 24"><path d="M7 5h14v2H7zM3 5h2v2H3zM7 11h14v2H7zM3 11h2v2H3zM7 17h14v2H7zM3 17h2v2H3z"/></svg></button>
      <button class="tool" data-cmd="insertOrderedList" aria-label="Numbered List"><svg viewBox="0 0 24 24"><path d="M7 5h14v2H7zM3 5h2v2H3zM7 11h14v2H7zM3 10h2v4H3zM7 17h14v2H7zM3 16h3v2H3z"/></svg></button>
      <button class="tool" data-cmd="outdent" aria-label="Outdent"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h10v2H3zM3 13h18v2H3zM3 17h10v2H3zM11 8l-4 4 4 4V8z"/></svg></button>
      <button class="tool" data-cmd="indent" aria-label="Indent"><svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM3 9h10v2H3zM3 13h18v2H3zM3 17h10v2H3zM13 8v8l4-4-4-4z"/></svg></button>
    </div>

    <div class="group">
      <button class="tool" id="linkBtn" aria-label="Insert Link"><svg viewBox="0 0 24 24"><path d="M3.9 12a5.1 5.1 0 0 1 5.1-5.1h3V9h-3a3 3 0 1 0 0 6h3v2.1h-3A5.1 5.1 0 0 1 3.9 12zm11.1-3V6.9h3A5.1 5.1 0 0 1 23.1 12 5.1 5.1 0 0 1 18 17.1h-3V15h3a3 3 0 1 0 0-6h-3zM10 11h4v2h-4z"/></svg></button>
      <button class="tool" id="emailBtn" aria-label="Insert Email Link"><svg viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></button>
      <button class="tool" id="imageBtn" aria-label="Insert Image"><svg viewBox="0 0 24 24"><path d="M19 4H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 13H4V7h16v10zM8 9a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-3 8l4-5 3 4 3-4 5 5H5z"/></svg></button>
      <input type="file" id="imageFile" accept="image/*" style="display:none">
      <button class="tool" data-cmd="undo" aria-label="Undo"><svg viewBox="0 0 24 24"><path d="M12 6a7 7 0 0 0-7 7H2l4 4 4-4H7a5 5 0 0 1 8.5-3.5l1.4-1.4A7 7 0 0 0 12 6z"/></svg></button>
      <button class="tool" data-cmd="redo" aria-label="Redo"><svg viewBox="0 0 24 24"><path d="M12 6a7 7 0 0 1 7 7h3l-4 4-4-4h3a5 5 0 0 0-8.5-3.5L6.1 8.1A7 7 0 0 1 12 6z"/></svg></button>
    </div>

    <div class="group">
      <label class="status">Text</label>
      <div class="color-wrap">
        <input class="tool" id="foreColor" type="color" value="#0b1220" title="Text color">
        <input id="foreHex" class="hex-input" value="#0b1220" aria-label="Text HEX">
      </div>
      <label class="status">Bg</label>
      <div class="color-wrap">
        <input class="tool" id="backColor" type="color" value="#fff4a3" title="Highlight color">
        <input id="backHex" class="hex-input" value="#fff4a3" aria-label="Background HEX">
      </div>
    </div>

    <div class="group">
      <button class="tool" id="cleanBtn" title="Clean unsafe HTML"><svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm2 4h14l-1.5 10h-11L5 10zm6-6h2v2h-2V4z"/></svg>Clean</button>
      <button class="tool" id="copyBtn" title="Copy HTML source"><svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z"/></svg>Copy</button>
      <button class="tool" id="downloadBtn" title="Download HTML"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM11 4h2v8h3l-4 4-4-4h3z"/></svg>Download</button>
      <button class="tool" id="clearBtn" title="Clear document"><svg viewBox="0 0 24 24"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>New</button>
    </div>
  </div>

  <div class="wrap">
    <div>
      <div class="card">
        <div id="editor" class="editor" contenteditable="true" role="textbox" aria-multiline="true" spellcheck="true">
          <h1>Welcome ðŸ‘‹</h1>
          <p>This editor uses <code>&lt;p&gt;</code> tags for new lines. Type here and press Enter!</p>
          <ul>
            <li>Insert images via toolbar, paste, or drag &amp; drop.</li>
            <li>Source (right) updates automatically â€” read-only by default.</li>
            <li>Autosaves to your browserâ€™s local storage.</li>
          </ul>
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="card">
        <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          HTML Source (one element per line)
          <span style="display:flex;gap:6px;align-items:center">
            <button class="tool" id="sourceToggle" title="Toggle edit source">Edit Source</button>
            <button class="tool" id="sourceApply" title="Apply source to editor" disabled>Apply</button>
          </span>
        </h3>
        <textarea id="code" class="code" aria-label="HTML source" readonly></textarea>
        <div class="status" id="charCount">0 chars</div>
      </div>
      <div class="card">
        <h3>Notepad (free text)</h3>
        <textarea id="notes" placeholder="Write anything hereâ€¦ (not linked to the code)"></textarea>
      </div>
    </aside>
  </div>

  <!-- Link Modal -->
  <dialog id="linkDialog">
    <form method="dialog" novalidate>
      <h3>Insert Link</h3>
      <label>Text
        <input type="text" id="linkText" placeholder="Link text">
      </label>
      <label>URL
        <input type="url" id="linkUrl" placeholder="https://example.com">
      </label>
      <label><input type="checkbox" id="linkBlank" checked> Open in new tab</label>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" formnovalidate>Cancel</button>
        <button id="linkApply" value="default">Insert</button>
      </menu>
    </form>
  </dialog>

  <!-- Email Modal -->
  <dialog id="emailDialog">
    <form method="dialog" novalidate>
      <h3>Insert Email Link</h3>
      <label>Text
        <input type="text" id="emailText" placeholder="Email link text">
      </label>
      <div class="row">
        <label>Email
          <input type="email" id="emailAddr" placeholder="name@example.com">
        </label>
        <label>Subject
          <input type="text" id="emailSubject" placeholder="Subject line">
        </label>
      </div>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" formnovalidate>Cancel</button>
        <button id="emailApply" value="default">Insert</button>
      </menu>
    </form>
  </dialog>

  <!-- Image Modal -->
  <dialog id="imageDialog">
    <form method="dialog" novalidate>
      <h3>Insert Image</h3>
      <label>Image URL
        <input type="url" id="imageUrl" placeholder="https://...">
      </label>
      <div style="display:flex;gap:8px;align-items:center;margin:10px 0">
        <span class="status">or</span>
        <button id="chooseFileBtn" type="button">Choose Fileâ€¦</button>
        <input type="file" id="imageFile2" accept="image/*" style="display:none">
      </div>
      <label>Alt text
        <input type="text" id="imageAlt" placeholder="Describe the image">
      </label>
      <menu style="display:flex;gap:8px;justify-content:flex-end">
        <button value="cancel" formnovalidate>Cancel</button>
        <button id="imageApply" value="default">Insert</button>
      </menu>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite">Copied!</div>

  <script>
    // --- Elements ---
    const root = document.documentElement;
    const editor = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const charCount = document.getElementById('charCount');
    const mainCount = document.getElementById('mainCount');
    const themeBtn = document.getElementById('themeBtn');
    const themeLabel = document.getElementById('themeLabel');
    const themeIcon = document.getElementById('themeIcon');
    const foreColor = document.getElementById('foreColor');
    const backColor = document.getElementById('backColor');
    const foreHex = document.getElementById('foreHex');
    const backHex = document.getElementById('backHex');
    const notes = document.getElementById('notes');
    const toast = document.getElementById('toast');
    const sourceToggle = document.getElementById('sourceToggle');
    const sourceApply = document.getElementById('sourceApply');

    document.execCommand('defaultParagraphSeparator', false, 'p');

    // --- Normalize paragraphs ---
    const INLINE_OK = new Set(['BR','IMG','A','SPAN','STRONG','EM','B','I','U','S','SMALL','SUP','SUB','CODE','KBD','MARK','TIME']);
    function wrapTopTextInParagraph(container){
      [...container.childNodes].forEach(node=>{
        if (node.nodeType===3 && node.nodeValue.trim()){
          const p=document.createElement('p');
          p.textContent=node.nodeValue.trim();
          node.replaceWith(p);
        }
      });
    }
    function removeTrailingEmptyParagraph(rootEl){
      const kids=[...rootEl.children]; if(!kids.length) return;
      const last=kids[kids.length-1];
      if (last.tagName==='P'){
        const html=last.innerHTML.replace(/\s+/g,'').toLowerCase();
        if (html==='' || html==='<br>' || html==='<br/>' || html==='<br/>'){
          if (kids.length>1) last.remove();
        }
      }
      if (editor.textContent.trim()===''){
        editor.innerHTML = '<p></p>';
      }
    }
    function normalizeDivsToParagraphs(rootEl){
      rootEl.querySelectorAll('div').forEach(div=>{
        const hasBlocks=[...div.children].some(c=>c.nodeType===1 && !INLINE_OK.has(c.tagName));
        if(!hasBlocks){
          const p=document.createElement('p');
          while(div.firstChild) p.appendChild(div.firstChild);
          div.replaceWith(p);
        }
      });
      wrapTopTextInParagraph(rootEl);
      removeTrailingEmptyParagraph(rootEl);
    }

    // --- Serializer (one element per line) ---
    const VOID = new Set(['AREA','BASE','BR','COL','EMBED','HR','IMG','INPUT','LINK','META','PARAM','SOURCE','TRACK','WBR']);
    function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function attrs(el){return Array.from(el.attributes).map(a=>` ${a.name}="${a.value.replace(/"/g,'&quot;')}"`).join('');}
    function serializeOneLine(rootEl){
      const lines=[];
      function visit(node){
        if(node.nodeType===1){
          const el=node; const tag=el.tagName.toLowerCase();
          if(VOID.has(el.tagName)){ lines.push(`<${tag}${attrs(el)}/>`);
            return;
          }
          if(tag==='ul'||tag==='ol'){
            lines.push(`<${tag}${attrs(el)}>`); Array.from(el.children).forEach(li=>{
              if(li.tagName==='LI'){ lines.push(`<li>${li.innerHTML.trim()}</li>`); }
            }); lines.push(`</${tag}>`); return;
          }
          const children=Array.from(el.childNodes);
          if(children.every(c=>c.nodeType!==1)){
            const text=el.textContent??''; lines.push(`<${tag}${attrs(el)}>${esc(text)}</${tag}>`);
          } else {
            lines.push(`<${tag}${attrs(el)}>`); children.forEach(c=>{
              if(c.nodeType===1) visit(c);
              else if(c.nodeType===3){ const t=c.nodeValue.trim(); if(t) lines.push(esc(t)); }
              else if(c.nodeType===8){ lines.push(`<!--${c.nodeValue}-->`); }
            }); lines.push(`</${tag}>`);
          }
        } else if(node.nodeType===3){ const t=node.nodeValue.trim(); if(t) lines.push(esc(t)); }
        else if(node.nodeType===8){ lines.push(`<!--${node.nodeValue}-->`); }
      }
      if (rootEl.childNodes.length===0){ return '<p></p>'; }
      Array.from(rootEl.childNodes).forEach(visit);
      const out = lines.join('\n').trim();
      return out || '<p></p>';
    }

    function updateCodeFromEditor(){
      const oneLine=serializeOneLine(editor);
      codeArea.value=oneLine;
      charCount.textContent=oneLine.length.toLocaleString()+' chars';
      mainCount.textContent=(editor.innerText||'').length.toLocaleString()+' chars';
    }

    // --- Exec helpers ---
    function exec(cmd,val=null){
      document.execCommand(cmd,false,val);
      editor.focus();
      normalizeDivsToParagraphs(editor);
      save();
      updateCodeFromEditor();
    }
    function setBlock(tag){
      if(tag==='p') exec('formatBlock','<p>');
      else if(tag==='blockquote') exec('formatBlock','<blockquote>');
      else if(tag==='pre') exec('formatBlock','<pre>');
      else exec('formatBlock','<'+tag+'>');
    }

    // --- Clear format (fix) ---
    function replaceTag(el, newTag){
      const n=document.createElement(newTag);
      while(el.firstChild) n.appendChild(el.firstChild);
      el.replaceWith(n); return n;
    }
    function blocksInSelection(){
      const sel=window.getSelection(); if(!sel.rangeCount) return [];
      const range=sel.getRangeAt(0);
      const container=range.commonAncestorContainer.nodeType===1?range.commonAncestorContainer:range.commonAncestorContainer.parentElement;
      const blocks=[];
      container.querySelectorAll('*').forEach(n=>{
        if(range.intersectsNode(n) && /^(P|H1|H2|H3|H4|H5|H6|BLOCKQUOTE|PRE)$/.test(n.tagName)) blocks.push(n);
      });
      if (blocks.length===0){
        const start=range.startContainer.nodeType===1?range.startContainer:range.startContainer.parentElement;
        const b=start.closest('p,h1,h2,h3,h4,h5,h6,blockquote,pre'); if (b) blocks.push(b);
      }
      return blocks;
    }
    function clearFormat(){
      document.execCommand('removeFormat');
      document.execCommand('unlink');
      blocksInSelection().forEach(b=>{
        if (/^H[1-6]$/.test(b.tagName) || b.tagName==='BLOCKQUOTE' || b.tagName==='PRE'){
          replaceTag(b,'p');
        }
      });
      // remove inline style attrs
      editor.querySelectorAll('[style]').forEach(n=> n.removeAttribute('style'));
      normalizeDivsToParagraphs(editor);
      save(); updateCodeFromEditor();
    }

    // --- Bindings ---
    document.querySelectorAll('button.tool[data-cmd]').forEach(btn=> btn.addEventListener('click', ()=> exec(btn.dataset.cmd)));
    document.getElementById('blockFormat').addEventListener('change', e=> setBlock(e.target.value));
    document.getElementById('clearFormatBtn').addEventListener('click', clearFormat);

    // Colors + HEX sync
    function toHex(v){ v=v.trim(); if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)) return v.length===4?('#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3]).toLowerCase():v.toLowerCase(); return null; }
    foreColor.addEventListener('input', e=>{ const v=e.target.value; foreHex.value=v; exec('foreColor', v); });
    backColor.addEventListener('input', e=>{ const v=e.target.value; backHex.value=v; exec('hiliteColor', v); });
    foreHex.addEventListener('change', e=>{ const v=toHex(e.target.value)||foreColor.value; foreHex.value=v; foreColor.value=v; exec('foreColor', v); });
    backHex.addEventListener('change', e=>{ const v=toHex(e.target.value)||backColor.value; backHex.value=v; backColor.value=v; exec('hiliteColor', v); });

    // --- Selection save/restore (dialogs) ---
    let savedRange=null;
    function saveSelection(){ const sel=window.getSelection(); if (sel.rangeCount) savedRange=sel.getRangeAt(0); }
    function restoreSelection(){ if (!savedRange) return; const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(savedRange); }

    // ----- Insert Link (no validation nag on cancel) -----
    const linkDialog=document.getElementById('linkDialog');
    document.getElementById('linkBtn').addEventListener('click', ()=>{
      saveSelection();
      const sel=window.getSelection();
      document.getElementById('linkText').value = sel && sel.toString()? sel.toString() : '';
      document.getElementById('linkUrl').value = '';
      document.getElementById('linkBlank').checked = true;
      linkDialog.showModal();
    });

    function insertLinkOrWrap(href, text, blank){
      restoreSelection();
      const sel=window.getSelection(); if(!sel.rangeCount) return;
      const range=sel.getRangeAt(0);
      const targetAttrs = (!href.startsWith('mailto:') && blank) ? ' target="_blank" rel="noopener noreferrer"' : '';
      const safeHref = href.replace(/"/g,'&quot;');
      const safeText = (text && text.length ? text : href).replace(/</g,'&lt;').replace(/>/g,'&gt;');

      if (sel.isCollapsed){
        document.execCommand('insertHTML', false, `<a href="${safeHref}"${targetAttrs}>${safeText}</a>`);
      } else {
        try {
          const a=document.createElement('a');
          a.setAttribute('href', href);
          if (targetAttrs){ a.setAttribute('target','_blank'); a.setAttribute('rel','noopener noreferrer'); }
          range.surroundContents(a);
        } catch {
          const frag = range.cloneContents();
          const div = document.createElement('div'); div.appendChild(frag);
          document.execCommand('insertHTML', false, `<a href="${safeHref}"${targetAttrs}>${div.innerHTML}</a>`);
        }
      }
      normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
    }

    document.getElementById('linkApply').addEventListener('click', ()=>{
      const text=document.getElementById('linkText').value.trim();
      const url=document.getElementById('linkUrl').value.trim();
      const blank=document.getElementById('linkBlank').checked;
      if (!url){ linkDialog.close(); return; }
      insertLinkOrWrap(url, text, blank);
      linkDialog.close();
    });

    // ----- Insert Email -----
    const emailDialog=document.getElementById('emailDialog');
    document.getElementById('emailBtn').addEventListener('click', ()=>{
      saveSelection();
      const sel=window.getSelection();
      document.getElementById('emailText').value = sel && sel.toString()? sel.toString() : '';
      document.getElementById('emailAddr').value = '';
      document.getElementById('emailSubject').value = '';
      emailDialog.showModal();
    });
    document.getElementById('emailApply').addEventListener('click', ()=>{
      const text=document.getElementById('emailText').value.trim();
      const email=document.getElementById('emailAddr').value.trim();
      const subject=document.getElementById('emailSubject').value.trim();
      if (!email){ emailDialog.close(); return; }
      const href=`mailto:${email}${subject?`?subject=${encodeURIComponent(subject)}`:''}`;
      insertLinkOrWrap(href, text, false);
      emailDialog.close();
    });

    // Image dialog
    const imageDialog=document.getElementById('imageDialog');
    document.getElementById('imageBtn').addEventListener('click', ()=>{
      saveSelection();
      document.getElementById('imageUrl').value=''; document.getElementById('imageAlt').value='';
      imageDialog.showModal();
    });
    document.getElementById('chooseFileBtn').addEventListener('click', ()=> document.getElementById('imageFile2').click());
    document.getElementById('imageFile2').addEventListener('change', handleImageFile);
    document.getElementById('imageFile').addEventListener('change', handleImageFile);
    document.getElementById('imageApply').addEventListener('click', ()=>{
      restoreSelection();
      const url=document.getElementById('imageUrl').value.trim();
      const alt=document.getElementById('imageAlt').value.trim();
      if (url){ exec('insertImage', url); setAltOnLatestImg(alt); }
      imageDialog.close();
    });
    function handleImageFile(e){
      const file=e.target.files[0]; if (!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ restoreSelection(); exec('insertImage', reader.result); setAltOnLatestImg(file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g,' ')); };
      reader.readAsDataURL(file); imageDialog.close(); e.target.value='';
    }
    function setAltOnLatestImg(alt){
      const imgs=editor.querySelectorAll('img');
      if (imgs.length){ const img=imgs[imgs.length-1]; if (alt) img.setAttribute('alt', alt); img.style.maxWidth='100%'; img.style.height='auto'; }
    }

    // Paste plain text
    editor.addEventListener('paste', (e)=>{
      e.preventDefault();
      const text=(e.clipboardData||window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
      normalizeDivsToParagraphs(editor); save(); updateCodeFromEditor();
    });

    // DnD images
    ;['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      editor.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); });
    });
    editor.addEventListener('drop', e=>{
      const files=e.dataTransfer.files;
      if (files && files.length){
        [...files].forEach(f=>{
          if (f.type.startsWith('image/')){
            const reader=new FileReader();
            reader.onload=()=>{ exec('insertImage', reader.result); setAltOnLatestImg(f.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g,' ')); };
            reader.readAsDataURL(f);
          }
        });
      } else {
        const url=e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
        if (url) exec('insertImage', url);
      }
    });

    // Shortcuts + keep empty <p></p>
    document.addEventListener('keydown', e=>{
      const meta=e.ctrlKey||e.metaKey;
      if (meta && e.key.toLowerCase()==='b'){ e.preventDefault(); exec('bold'); }
      if (meta && e.key.toLowerCase()==='i'){ e.preventDefault(); exec('italic'); }
      if (meta && e.key.toLowerCase()==='u'){ e.preventDefault(); exec('underline'); }
      if (e.key==='Backspace'){ setTimeout(()=>{ if (editor.textContent.trim()==='') { editor.innerHTML='<p></p>'; updateCodeFromEditor(); save(); } }, 0); }
    });

    // Clean + sync
    function cleanHTML(html){
      const tmp=document.createElement('div'); tmp.innerHTML=html;
      tmp.querySelectorAll('script, style, iframe, object, embed, link, meta').forEach(n=>n.remove());
      tmp.querySelectorAll('*').forEach(el=>{
        [...el.attributes].forEach(a=>{
          if (/^on/i.test(a.name)) el.removeAttribute(a.name);
          if ((a.name==='href'||a.name==='src') && /^\s*javascript:/i.test(a.value)) el.removeAttribute(a.name);
        });
      });
      normalizeDivsToParagraphs(tmp);
      return tmp.innerHTML;
    }
    document.getElementById('cleanBtn').addEventListener('click', ()=>{
      editor.innerHTML = cleanHTML(editor.innerHTML);
      save(); updateCodeFromEditor();
    });

    // Toast
    function showToast(msg='Copied!'){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }

    // Copy source
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(codeArea.value); showToast('HTML copied'); }
      catch{ codeArea.removeAttribute('readonly'); codeArea.select(); document.execCommand('copy'); codeArea.setAttribute('readonly',''); showToast('HTML copied'); }
    });

    // Download
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const blob=new Blob([wrapAsDocument(editor.innerHTML)], {type:'text/html;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='document.html'; a.click();
      URL.revokeObjectURL(a.href);
    });
    function wrapAsDocument(bodyHTML){
      return `<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Exported</title></head>
<body>${bodyHTML}</body></html>`;
    }

    // Clear document
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      editor.innerHTML = '<p></p>';
      save(); updateCodeFromEditor();
    });

    // Autosave (doc + notes)
    const LS_DOC='wysiwyg-doc-v10', LS_NOTES='wysiwyg-notes-v1';
    function save(){ try{ localStorage.setItem(LS_DOC, editor.innerHTML); }catch{} }
    function load(){
      try{ const d=localStorage.getItem(LS_DOC); if (d) editor.innerHTML=d; }catch{}
      normalizeDivsToParagraphs(editor);
      try{ const n=localStorage.getItem(LS_NOTES); if (n!=null) notes.value=n; }catch{}
    }
    notes.addEventListener('input', ()=>{ try{ localStorage.setItem(LS_NOTES, notes.value); }catch{} });

    // Observe editor -> update source
    const obs=new MutationObserver(()=>{ updateCodeFromEditor(); save(); });
    obs.observe(editor, {subtree:true, childList:true, characterData:true});

    // --- Edit Source toggle (bi-directional) ---
    let sourceEditing=false, debounceTimer=null;
    sourceToggle.addEventListener('click', ()=>{
      sourceEditing = !sourceEditing;
      sourceToggle.textContent = sourceEditing ? 'Editingâ€¦' : 'Edit Source';
      codeArea.toggleAttribute('readonly', !sourceEditing);
      sourceApply.disabled = !sourceEditing;
      if (sourceEditing){ codeArea.focus(); }
    });
    codeArea.addEventListener('input', ()=>{
      if (!sourceEditing) return;
      sourceApply.disabled=false;
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(applySourceToEditor,false?0:400);
    });
    sourceApply.addEventListener('click', applySourceToEditor);
    function applySourceToEditor(){
      try{
        const sanitized = cleanHTML(codeArea.value);
        editor.innerHTML = sanitized;
        normalizeDivsToParagraphs(editor);
        updateCodeFromEditor();
        save();
        sourceApply.disabled=true;
      }catch(e){ /* if invalid, just ignore */ }
    }

    // Init
    load(); updateCodeFromEditor();

    // Button active states
    function refreshActiveStates(){
      const map={bold:'bold', italic:'italic', underline:'underline', strikeThrough:'strikeThrough', superscript:'superscript'};
      document.querySelectorAll('button.tool[data-cmd]').forEach(btn=>{
        const cmd=btn.dataset.cmd;
        if (map[cmd]) btn.setAttribute('aria-pressed', document.queryCommandState(cmd)?'true':'false');
      });
    }
    setInterval(refreshActiveStates, 300);

    // THEME
    const THEME_KEY='wysiwyg-theme-pref';
    function applyTheme(mode){
      if (mode==='light'){ root.setAttribute('data-theme','light'); themeLabel.textContent='Light'; setIcon('sun'); }
      else if (mode==='dark'){ root.setAttribute('data-theme','dark'); themeLabel.textContent='Dark'; setIcon('moon'); }
      else { root.setAttribute('data-theme',''); themeLabel.textContent='System'; setIcon('auto'); }
      try{ localStorage.setItem(THEME_KEY, mode); }catch{}
    }
    function setIcon(kind){
      if (kind==='moon'){ themeIcon.innerHTML='<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>'; }
      else if (kind==='sun'){ themeIcon.innerHTML='<path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM12 4V1h0v3h0zm5.24.84l1.79-1.8 1.41 1.41-1.8 1.79-1.4-1.4zM4 12H1v0h3v0zm19 0h-3v0h3v0zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zM20.45 18.36l1.41 1.41-1.79 1.79-1.4-1.4 1.78-1.8zM12 23v-3h0v3h0zM12 7a5 5 0 100 10 5 5 0 000-10z"/>'; }
      else { themeIcon.innerHTML='<path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4v12a6 6 0 010-12z"/>'; }
    }
    function nextTheme(mode){ return mode==='system' ? 'light' : mode==='light' ? 'dark' : 'system'; }
    function initTheme(){
      let saved='system'; try{ saved=localStorage.getItem(THEME_KEY)||'system'; }catch{}
      applyTheme(saved);
      const mq=window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener?.('change', ()=>{ if ((localStorage.getItem(THEME_KEY)||'system')==='system'){ applyTheme('system'); }});
    }
    themeBtn.addEventListener('click', ()=>{
      const current = localStorage.getItem(THEME_KEY) || 'system';
      applyTheme(nextTheme(current));
    });
    initTheme();
  </script>
</body>
</html>
