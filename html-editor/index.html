<!doctype html>
<!--
=========================================================
 WYSIWYG HTML Editor - Developer Branch
 File: editor-dev-v1.6.3.html
 Build: v1.6.3-dev
=========================================================
Highlights (v1.6.3)
- Single-line <p> normalization (no random wraps inside <p>), keeps inline <em>/<strong>/<a>/<sup>.
- Word Sanitizer preserves footnotes (#_ftn*/#_ftnref*), converts <b>/<i> to <strong>/<em>.
- Cleans <br></br> to <br>, removes empty <p> directly before <ul>/<ol>.
- External links => target="_blank"; mailto/# anchors => no target.
- Notes panel text updated.
=========================================================
-->
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WYSIWYG HTML Editor (DEV v1.6.3)</title>

<style>
  /* ===== THEME VARS ===== */
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f1f3f9; --text:#101321; --muted:#5a6279;
    --accent:#2563eb; --border:#dfe3ee; --danger:#dc2626;
  }
  [data-theme="dark"]{
    --bg:#0f1220; --panel:#171a2a; --panel-2:#1f2336; --text:#e7e9f3; --muted:#a8afc4;
    --accent:#6ea8fe; --border:#2a2f45; --danger:#ff6b6b;
  }

  /* ===== LAYOUT ===== */
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:32px auto;padding:16px}
  .titlebar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .titlebar h1{font-size:18px;margin:0;opacity:.9}
  .status{margin-left:auto;font-size:12px;color:var(--muted)}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}

  .editor{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--panel);
    box-shadow:0 8px 36px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.4)}
  [data-theme="dark"] .editor{box-shadow:0 8px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03)}

  .toolbar{
    display:flex;gap:6px;flex-wrap:wrap;padding:10px;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,rgba(0,0,0,.02),transparent);position:sticky;top:0;z-index:5
  }
  [data-theme="dark"] .toolbar{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
  .group{display:flex;gap:6px;padding-right:8px;border-right:1px solid var(--border)}
  .group:last-child{border-right:none;padding-right:0}
  button.tool{
    appearance:none;border:1px solid var(--border);background:var(--panel-2);color:var(--text);
    height:36px;padding:0 10px;border-radius:9px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:13px;
  }
  button.tool:hover{filter:brightness(0.97)}
  [data-theme="dark"] button.tool:hover{background:#252a42;filter:none}
  .tool svg{width:16px;height:16px;opacity:.9}
  select.tool, input[type="color"].tool{
    height:36px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);
    border-radius:9px;padding:0 8px;font-size:13px;cursor:pointer;
  }

  .content{min-height:380px;padding:18px 20px;outline:none;line-height:1.6}
  .content:empty:before{content:attr(data-placeholder);color:var(--muted)}
  .content h1,.content h2,.content h3{line-height:1.25;margin:1.1em 0 .4em}
  .content img{max-width:100%;border-radius:8px}

  .source{width:100%;min-height:380px;display:none;border:0;outline:none;background:color-mix(in srgb, var(--bg) 95%, #fff);
    color:inherit;padding:18px 20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  [data-theme="dark"] .source{background:#0a0d1a;color:#dbe1ff}

  .footerbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-top:1px solid var(--border);
    background:linear-gradient(0deg,rgba(0,0,0,.02),transparent);color:var(--muted);font-size:12px}
  [data-theme="dark"] .footerbar{background:linear-gradient(0deg,rgba(255,255,255,.03),transparent)}
  .chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .chip{border:1px dashed var(--border);padding:6px 8px;border-radius:8px;display:inline-flex;gap:6px;align-items:center}
  .btn-flat{background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:8px;height:32px;padding:0 10px;cursor:pointer}
  .btn-accent{background:linear-gradient(180deg,var(--accent),color-mix(in srgb,var(--accent) 60%, #000));border:0;color:#ffffff;font-weight:600;border-radius:9px;height:36px;padding:0 12px;cursor:pointer}
  [data-theme="dark"] .btn-accent{color:#0b1020}
  .btn-danger{background:linear-gradient(180deg,#ff8383,var(--danger));color:#1a0d0d}

  /* NOTES */
  .notes{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:12px;display:flex;flex-direction:column;gap:10px;height:min(560px,70vh)}
  .notes h2{font-size:16px;margin:0;opacity:.9}
  .notes textarea{flex:1;resize:vertical;min-height:200px;border:1px dashed var(--border);background:color-mix(in srgb, var(--bg) 95%, #fff);color:inherit;border-radius:8px;padding:10px;font-family:Inter,system-ui,Arial}
  [data-theme="dark"] .notes textarea{background:#0b0f1d;color:#cfe3ff}

  /* Modals */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(560px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal h3{margin:0;font-size:16px}
  .modal .fields{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
  .modal .row{display:contents}
  .modal footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .modal input,.modal textarea,.modal select{width:100%;height:36px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);border-radius:8px;padding:0 10px;font-size:14px}
  .modal textarea{height:90px;padding:10px;resize:vertical}
  .close-x{background:none;border:0;color:var(--muted);font-size:18px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <h1 id="docTitle" contenteditable="true" aria-label="Document title">Untitled Document</h1>
    <span class="status" id="status">Saved</span>
  </div>

  <div class="layout">
    <div class="editor" id="editor">
      <div class="toolbar" role="toolbar" aria-label="Formatting toolbar">
        <div class="group">
          <button class="tool" data-cmd="bold" title="Bold (Ctrl+B)">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.6 10.79A4.79 4.79 0 0 0 12 3H7v18h7a4 4 0 0 0 1.6-7.21zM9 5h3a2 2 0 0 1 0 4H9zm4 12H9v-4h4a2 2 0 0 1 0 4z"/></svg>
          </button>
          <button class="tool" data-cmd="italic" title="Italic (Ctrl+I)">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M10 4v3h2.21l-3.42 10H6v3h8v-3h-2.21l3.42-10H18V4z"/></svg>
          </button>
          <button class="tool" data-cmd="underline" title="Underline (Ctrl+U)">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 17a5 5 0 0 0 5-5V4h-2v8a3 3 0 0 1-6 0V4H7v8a5 5 0 0 0 5 5zM5 20h14v-2H5z"/></svg>
          </button>
          <button class="tool" data-cmd="strikeThrough" title="Strikethrough">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 8c0-2.2 2.1-4 6-4 2.5 0 4.7.7 6 1.8l-1.2 1.6C15.7 6.5 14.1 6 12 6c-2.7 0-4 .9-4 2h12v2H4V8h2zm12 4v2c0 2.2-2.1 4-6 4-2.5 0-4.7-.7-6-1.8l1.2-1.6c1.1.9 2.7 1.4 4.8 1.4 2.7 0 4-.9 4-2H6v-2h12z"/></svg>
          </button>
          <button class="tool" id="supBtn" title="Superscript">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M5 5h2l3 4 3-4h2l-4 6 4 6h-2l-3-4-3 4H5l4-6z"/>
              <path fill="currentColor" d="M18 5h4v1.5h-2.5V8H22v1.5h-4z"/>
            </svg>
          </button>
        </div>

        <div class="group">
          <select class="tool" id="blockFormat" title="Block style">
            <option value="p">Paragraph</option>
            <option value="h1">Heading 1</option>
            <option value="h2">Heading 2</option>
            <option value="h3">Heading 3</option>
          </select>
          <input class="tool" type="color" id="foreColor" title="Text color" value="#222222"/>
          <input class="tool" type="color" id="backColor" title="Highlight color" value="#fff59d"/>
        </div>

        <div class="group">
          <button class="tool" data-cmd="insertUnorderedList" title="Bulleted list">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 5h14v2H7zM7 11h14v2H7zM7 17h14v2H7zM3 5h2v2H3zM3 11h2v2H3zM3 17h2v2H3z"/></svg>
          </button>
          <button class="tool" data-cmd="insertOrderedList" title="Numbered list">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M9 5h12v2H9V5zm0 6h12v2H9v-2zm0 6h12v2H9v-2z"/>
              <path fill="currentColor" d="M2 5h3v1H3v1H2V5zm1 6h2v1H3v1h2v1H2v-3zm1 6h2v4H3v-3H2v-1h2z"/>
            </svg>
          </button>
          <button class="tool" data-cmd="outdent" title="Outdent">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M3 4h18v2H3zM3 18h18v2H3zM11 9v6l-4-3zM3 11h8v2H3zM15 8h6v8h-6z"/>
            </svg>
          </button>
          <button class="tool" data-cmd="indent" title="Indent">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M3 4h18v2H3zM3 18h18v2H3zM13 9v6l4-3zM3 11h8v2H3zM13 8h6v8h-6z"/>
            </svg>
          </button>
        </div>

        <div class="group">
          <button class="tool" data-cmd="justifyLeft" title="Align left">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18v2H3zM3 8h10v2H3zM3 12h18v2H3zM3 16h10v2H3zM3 20h18v2H3z"/></svg>
          </button>
          <button class="tool" data-cmd="justifyCenter" title="Align center">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18v2H3zM7 8h10v2H7zM3 12h18v2H3zM7 16h10v2H7zM3 20h18v2H3z"/></svg>
          </button>
          <button class="tool" data-cmd="justifyRight" title="Align right">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18v2H3zM11 8h10v2H11zM3 12h18v2H3zM11 16h10v2H11zM3 20h18v2H3z"/></svg>
          </button>
          <button class="tool" data-cmd="justifyFull" title="Justify">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18v2H3zM3 8h18v2H3zM3 12h18v2H3zM3 16h18v2H3zM3 20h18v2H3z"/></svg>
          </button>
        </div>

        <div class="group">
          <button class="tool" id="linkModalBtn" title="Insert/edit link (Ctrl+K)">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M3.9 12a4.1 4.1 0 0 1 4.1-4.1h3v2h-3A2.1 2.1 0 0 0 5 12a2.1 2.1 0 0 0 2.1 2.1h3v2h-3A4.1 4.1 0 0 1 3.9 12zM13 9.9h3A4.1 4.1 0 1 1 16 18h-3v-2h3a2.1 2.1 0 1 0 0-4.2h-3v-2z"/>
            </svg>
          </button>
          <button class="tool" id="mailtoModalBtn" title="Insert/edit mailto link">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 4-8 5-8-5V6l8 5 8-5z"/></svg>
          </button>
          <button class="tool" id="imageModalBtn" title="Insert image">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5 11 17l2.5-3.22L17.5 19H5z"/></svg>
          </button>
          <button class="tool" id="clearBtn" title="Clear formatting">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M3.27 3 2 4.27 7.73 10H5v2h4.73l2 2H5v2h8.73L19.73 21 21 19.73 3.27 3zM15 3H7v2h8V3z"/>
            </svg>
          </button>
          <button class="tool" id="copyHtmlToolbarBtn" title="Copy formatted HTML">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16h14a2 2 0 0 0 2-2V5z"/></svg>
          </button>
          <!-- Source toggle icon = '</>' (industry style) -->
          <button class="tool" id="toggleSource" title="Toggle HTML / Design (Esc)">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M8.5 12 4 7.5 5.5 6l6 6-6 6L4 16.5 8.5 12zM15.5 12l4.5-4.5L18.5 6l-6 6 6 6 1.5-1.5z"/>
            </svg>
          </button>
          <button class="tool" data-cmd="undo" title="Undo">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6a6 6 0 0 1-6 6c-2.67 0-5.16-1.64-5.82-4H4.26c.72 4.12 4.29 7 8.74 7 4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
          </button>
          <button class="tool" data-cmd="redo" title="Redo">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <g transform="translate(24,0) scale(-1,1)">
                <path fill="currentColor" d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6a6 6 0 0 1-6 6c-2.67 0-5.16-1.64-5.82-4H4.26c.72 4.12 4.29 7 8.74 7 4.97 0 9-4.03 9-9s-4.03-9-9-9z"/>
              </g>
            </svg>
          </button>
        </div>
      </div>

      <div id="content" class="content" contenteditable="true" data-placeholder="Start typingâ€¦"></div>
      <textarea id="source" class="source" aria-label="HTML source view"></textarea>

      <div class="footerbar">
        <div class="chips">
          <span class="chip">Autosave: on</span>
          <span class="chip">DEV v1.6.3</span>
          <label class="chip" title="Choose how pasted content is handled">
            Paste mode:
            <select id="pasteMode">
              <option value="plain" selected>Plain text</option>
              <option value="word">Word sanitized</option>
            </select>
          </label>
          <label class="chip" title="Switch theme">
            Theme:
            <select id="themeMode">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="auto" selected>Auto (System)</option>
            </select>
          </label>
          <span class="chip">Tip: Ctrl/Cmd + click a link to open</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-flat" id="copyHtmlBtn" title="Copy formatted HTML">Copy HTML</button>
          <button class="btn-flat" id="importBtn" title="Import HTML">Import</button>
          <button class="btn-accent" id="exportBtn" title="Download HTML">Export</button>
          <button class="btn-accent btn-danger" id="resetBtn" title="Clear document">New</button>
        </div>
      </div>
    </div>

    <!-- Notes (not exported) -->
    <aside class="notes">
      <h2>Your notes (not part of HTML)</h2>
      <textarea id="notesArea" placeholder="Keep temporary notes or code hereâ€¦"></textarea>
    </aside>
  </div>
</div>

<!-- Link Modal -->
<div class="modal-backdrop" id="linkModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="linkTitle">
    <header><h3 id="linkTitle">Insert/edit link</h3><button class="close-x" data-close="linkModal">âœ•</button></header>
    <div class="fields">
      <div class="row"><label for="linkText">Text</label><input id="linkText" placeholder="Link text"/></div>
      <div class="row"><label for="linkUrl">URL</label><input id="linkUrl" placeholder="https://example.com"/></div>
      <div class="row"><label for="linkTarget">Open in</label>
        <select id="linkTarget"><option value="_blank">New tab</option><option value="_self">Same tab</option></select>
      </div>
    </div>
    <footer><button class="btn-flat" data-close="linkModal">Cancel</button><button class="btn-accent" id="linkInsertBtn">Save</button></footer>
  </div>
</div>

<!-- Mailto Modal -->
<div class="modal-backdrop" id="mailtoModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mailtoTitle">
    <header><h3 id="mailtoTitle">Insert/edit mailto link</h3><button class="close-x" data-close="mailtoModal">âœ•</button></header>
    <div class="fields">
      <div class="row"><label for="mailTo">To</label><input id="mailTo" placeholder="name@example.com"/></div>
      <div class="row"><label for="mailSubject">Subject</label><input id="mailSubject" placeholder="Hello"/></div>
      <div class="row"><label for="mailBody">Body</label><textarea id="mailBody" placeholder="Messageâ€¦"></textarea></div>
      <div class="row"><label for="mailText">Link text</label><input id="mailText" placeholder="Email us"/></div>
    </div>
    <footer><button class="btn-flat" data-close="mailtoModal">Cancel</button><button class="btn-accent" id="mailtoInsertBtn">Save</button></footer>
  </div>
</div>

<!-- Image Modal -->
<div class="modal-backdrop" id="imageModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="imageTitle">
    <header><h3 id="imageTitle">Insert image</h3><button class="close-x" data-close="imageModal">âœ•</button></header>
    <div class="fields">
      <div class="row"><label for="imgUrl">Image URL</label><input id="imgUrl" placeholder="https://â€¦"/></div>
      <div class="row"><label for="imgAlt">Alt text</label><input id="imgAlt" placeholder="Description"/></div>
      <div class="row"><label>Upload</label><input type="file" id="imgFile" accept="image/*"/></div>
      <div class="row"><label for="imgWidth">Width</label><input id="imgWidth" type="number" min="0" placeholder="Auto (px)"/></div>
    </div>
    <footer><button class="btn-flat" data-close="imageModal">Cancel</button><button class="btn-accent" id="imageInsertBtn">Insert</button></footer>
  </div>
</div>
<script>
(() => {
  const $ = id => document.getElementById(id);
  const content = $('content'),
        source = $('source'),
        status = $('status'),
        titleEl = $('docTitle'),
        blockSelect = $('blockFormat');

  // Versioned storage (v1.6.3)
  const DOC_KEY='wysi_doc_dev_v163';
  const NOTES_KEY='wysi_notes_dev_v163';
  const THEME_MODE_KEY='wysi_theme_mode_dev_v163';

  /* ===== Theme: Light/Dark/Auto (Auto default) ===== */
  const themeSelect=$('themeMode');
  const mql=window.matchMedia('(prefers-color-scheme: dark)');
  let themeMode='auto';
  function applyTheme(mode){ document.documentElement.setAttribute('data-theme', mode==='dark'?'dark':'light'); }
  function applySystemTheme(){ applyTheme(mql.matches?'dark':'light'); }
  function onSystemChange(){ if(themeMode==='auto') applySystemTheme(); }
  function setThemeMode(mode){
    themeMode=mode;
    try{ localStorage.setItem(THEME_MODE_KEY,mode); }catch{}
    if(mode==='auto'){ applySystemTheme(); mql.addEventListener('change', onSystemChange); }
    else { mql.removeEventListener('change', onSystemChange); applyTheme(mode); }
  }
  (()=>{
    const saved=localStorage.getItem(THEME_MODE_KEY)||'auto';
    themeSelect.value=saved; setThemeMode(saved);
  })();
  themeSelect.addEventListener('change', e=> setThemeMode(e.target.value));

  // Default paragraph separator = <p>
  try{ document.execCommand('defaultParagraphSeparator', false, 'p'); }catch{}

  /* ===== Selection save/restore for modals ===== */
  let savedRange=null;
  function selectionInside(){ const s=window.getSelection(); return s && s.rangeCount && content.contains(s.anchorNode); }
  function saveSelection(){
    const s=window.getSelection();
    if(s && s.rangeCount && content.contains(s.anchorNode)){ savedRange = s.getRangeAt(0).cloneRange(); }
  }
  function restoreSelection(){
    if(!savedRange) return; const s=window.getSelection(); s.removeAllRanges(); s.addRange(savedRange);
  }
  document.addEventListener('selectionchange', ()=>{ if(selectionInside()) saveSelection(); });

  /* ===== Normalizers / Cleanup ===== */
  function normalizeInlineTags(root){
    // Convert <b> -> <strong>, <i> -> <em>
    root.querySelectorAll('b').forEach(b=>{ const s=document.createElement('strong'); s.innerHTML=b.innerHTML; b.replaceWith(s); });
    root.querySelectorAll('i').forEach(i=>{ const e=document.createElement('em'); e.innerHTML=i.innerHTML; i.replaceWith(e); });
  }
  function flattenParagraphInline(p){
    // Remove <br> inside <p>
    p.querySelectorAll('br').forEach(br=> br.remove());
    // Collapse whitespace in text nodes
    const walker = document.createTreeWalker(p, NodeFilter.SHOW_TEXT);
    const texts = [];
    while (walker.nextNode()) texts.push(walker.currentNode);
    texts.forEach(n=>{
      n.nodeValue = n.nodeValue.replace(/\u00A0/g,' ').replace(/\s+/g,' ');
    });
    // Trim edges
    if (p.firstChild && p.firstChild.nodeType===3) p.firstChild.nodeValue = p.firstChild.nodeValue.replace(/^\s+/, '');
    if (p.lastChild && p.lastChild.nodeType===3)  p.lastChild.nodeValue  = p.lastChild.nodeValue.replace(/\s+$/, '');
    // Remove empty text nodes
    Array.from(p.childNodes).forEach(n=>{ if(n.nodeType===3 && !n.nodeValue.trim()) n.remove(); });
  }
  function collapseConsecutiveBR(root){
    const brs = Array.from(root.querySelectorAll('br'));
    brs.forEach(br=>{
      let prev=br.previousSibling;
      while(prev && prev.nodeType===3 && !prev.textContent.trim()) prev=prev.previousSibling;
      if(prev && prev.nodeType===1 && prev.tagName==='BR'){ br.remove(); }
    });
  }
  function removeEmptyPBeforeLists(root){
    const nodes = Array.from(root.querySelectorAll('p'));
    nodes.forEach(p=>{
      const isEmpty = !p.textContent.trim() && p.children.length===0;
      if (!isEmpty) return;
      const nxt = p.nextElementSibling;
      if (nxt && (nxt.tagName==='UL' || nxt.tagName==='OL')) p.remove();
    });
  }
  function ensureParagraph(){
    if (!content.textContent.trim() && content.innerHTML.trim() === '') {
      content.innerHTML = '<p>\u200B</p>';
      const p = content.querySelector('p'); if (p) placeCaretInside(p);
    }
  }
  function normalizeBRMarkup(html){
    // turn <br></br> into <br>
    return html.replace(/<br\s*\/?>\s*<\/br>/gi, '<br>');
  }
  function normalizeEditorDOM(root){
    normalizeInlineTags(root);
    enforceLinkTargets(root);
    removeEmptyPBeforeLists(root);
    collapseConsecutiveBR(root);
    // Make every paragraph single-line but preserve inline tags
    root.querySelectorAll('p').forEach(flattenParagraphInline);
    ensureParagraph();
  }

  /* ===== Helpers ===== */
  function placeCaretInside(el, atEnd=true){
    const r=document.createRange(); r.selectNodeContents(el); r.collapse(atEnd);
    const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
  }
  function insertNodeAtSelection(node){
    const sel=window.getSelection();
    if(!sel || !sel.rangeCount){ content.appendChild(node); return; }
    const r=sel.getRangeAt(0); r.deleteContents(); r.insertNode(node);
    r.setStartAfter(node); r.setEndAfter(node); sel.removeAllRanges(); sel.addRange(r);
  }
  function selectInserted(chars){
    const sel=window.getSelection(); if(!sel.rangeCount) return;
    const r=sel.getRangeAt(0); const node=r.startContainer;
    const nr=document.createRange();
    if(node.nodeType===3){ nr.setStart(node, Math.max(0,node.length-chars)); nr.setEnd(node,node.length); }
    else { nr.selectNodeContents(node); nr.collapse(false); }
    sel.removeAllRanges(); sel.addRange(nr);
  }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function flash(msg){ status.textContent=msg; setTimeout(()=>status.textContent='Saved',1200); }

  /* ===== Toolbar execCommand bindings ===== */
  document.querySelectorAll('button.tool[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      content.focus();
      document.execCommand(btn.dataset.cmd,false,null);
      // After formatting, normalize inline tag names
      normalizeInlineTags(content);
      // Keep paragraphs tidy
      normalizeEditorDOM(content);
      queueSave();
    });
  });
  $('foreColor').addEventListener('input', e=>{ content.focus(); document.execCommand('foreColor',false,e.target.value); queueSave(); });
  $('backColor').addEventListener('input', e=>{ content.focus(); document.execCommand('hiliteColor',false,e.target.value); queueSave(); });
  $('supBtn').addEventListener('click', ()=>{ content.focus(); document.execCommand('superscript',false,null); queueSave(); });

  /* ===== Block format (p/h1/h2/h3) ===== */
  blockSelect.addEventListener('change', e=> setBlockTag(e.target.value));
  function setBlockTag(tag){
    const sel=window.getSelection(); if(!sel || !sel.rangeCount) return;
    const r=sel.getRangeAt(0);
    let block=currentBlock();
    if(!block || block===content){
      const el=document.createElement(tag);
      if(r.collapsed){
        el.appendChild(document.createTextNode('\u200B'));
        r.insertNode(el); placeCaretInside(el,true);
      } else {
        el.appendChild(r.extractContents()); r.insertNode(el); placeCaretInside(el,true);
      }
      normalizeEditorDOM(content);
      queueSave(); return;
    }
    if(block.tagName.toLowerCase()===tag){ placeCaretInside(block,true); return; }
    const neo=document.createElement(tag);
    while(block.firstChild) neo.appendChild(block.firstChild);
    block.replaceWith(neo); placeCaretInside(neo,true);
    normalizeEditorDOM(content);
    queueSave();
  }
  function currentBlock(){
    const sel=window.getSelection(); if(!sel || !sel.rangeCount) return null;
    let n=sel.anchorNode; if(n && n.nodeType===3) n=n.parentNode;
    while(n && n!==content){
      if(n.nodeType===1 && /^(p|h1|h2|h3|blockquote|div|pre|li|td|th)$/i.test(n.tagName)) return n;
      n=n.parentNode;
    }
    return content;
  }
  document.addEventListener('selectionchange', ()=>{
    const sel=window.getSelection(); let v='p';
    if(sel && sel.rangeCount){
      let n=sel.anchorNode; if(n && n.nodeType===3) n=n.parentNode;
      while(n && n!==content){
        const t=(n.tagName||'').toLowerCase();
        if(t==='p'||t==='h1'||t==='h2'||t==='h3'){ v=t; break; }
        n=n.parentNode;
      }
    }
    blockSelect.value=v;
  });

  /* ===== Modals infra ===== */
  function showModal(id){ saveSelection(); const m=$(id); m.style.display='flex'; setTimeout(()=>m.querySelector('input,textarea,select')?.focus(),0); }
  function closeModal(id){ $(id).style.display='none'; content.focus(); }
  document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeModal(b.dataset.close)));
  ['linkModal','mailtoModal','imageModal'].forEach(id=> $(id).addEventListener('click',e=>{ if(e.target.id===id) closeModal(id); }));

  function findClosest(tag){
    const sel=window.getSelection(); if(!sel || !sel.rangeCount) return null;
    let n=sel.anchorNode;
    while(n && n!==content){ if(n.nodeType===1 && n.tagName===tag) return n; n=n.parentNode; }
    return null;
  }

  /* ===== Link modal ===== */
  let currentLink=null;
  $('linkModalBtn').addEventListener('click', ()=>{
    const sel=window.getSelection();
    currentLink = findClosest('A');
    if(currentLink && currentLink.href?.toLowerCase().startsWith('mailto:')) currentLink=null;
    $('linkText').value = currentLink ? (currentLink.textContent||'') : (sel?.toString()||'link');
    $('linkUrl').value  = currentLink ? (currentLink.getAttribute('href')||'') : 'https://';
    $('linkTarget').value = currentLink ? (currentLink.getAttribute('target')||'_blank') : '_blank';
    showModal('linkModal');
  });
  $('linkInsertBtn').addEventListener('click', ()=>{
    restoreSelection(); content.focus();
    const t=($('linkText').value||'link').trim();
    const u=($('linkUrl').value||'#').trim();
    const trg=$('linkTarget').value;

    if(currentLink && document.body.contains(currentLink)){
      currentLink.setAttribute('href', u);
      if(trg==='_blank') currentLink.setAttribute('target','_blank'); else currentLink.removeAttribute('target');
      currentLink.removeAttribute('rel'); currentLink.removeAttribute('style');
      if(currentLink.textContent!==t) currentLink.textContent=t;
    } else {
      const sel=window.getSelection();
      if(!sel.rangeCount || sel.toString().length===0){ document.execCommand('insertText',false,t); selectInserted(t.length); }
      document.execCommand('createLink',false,u);
      const a=findClosest('A');
      if(a){
        if(trg==='_blank') a.setAttribute('target','_blank'); else a.removeAttribute('target');
        a.removeAttribute('rel'); a.removeAttribute('style');
      }
    }
    currentLink=null; closeModal('linkModal'); enforceLinkTargets(content); normalizeEditorDOM(content); queueSave();
  });

  /* ===== Mailto modal ===== */
  let currentMailto=null;
  $('mailtoModalBtn').addEventListener('click', ()=>{
    currentMailto = findClosest('A');
    if(currentMailto && currentMailto.href?.toLowerCase().startsWith('mailto:')){
      const {to,subject,body}=parseMailto(currentMailto.getAttribute('href'));
      $('mailTo').value=to||''; $('mailSubject').value=subject||''; $('mailBody').value=body||''; $('mailText').value=currentMailto.textContent||'Email us';
    } else {
      currentMailto=null;
      $('mailTo').value=''; $('mailSubject').value=''; $('mailBody').value=''; $('mailText').value='Email us';
    }
    showModal('mailtoModal');
  });
  $('mailtoInsertBtn').addEventListener('click', ()=>{
    restoreSelection(); content.focus();
    const to=$('mailTo').value.trim(), sub=$('mailSubject').value.trim(), body=$('mailBody').value.trim();
    const txt=($('mailText').value||to||'Email').trim();
    const href=buildMailto(to,sub,body);
    const sel=window.getSelection();
    if(!sel.rangeCount || sel.toString().length===0){ document.execCommand('insertText',false,txt); selectInserted(txt.length); }
    document.execCommand('createLink',false,href);
    const a=findClosest('A'); if(a){ a.removeAttribute('target'); a.removeAttribute('rel'); a.removeAttribute('style'); }
    currentMailto=null; closeModal('mailtoModal'); normalizeEditorDOM(content); queueSave();
  });
  function parseMailto(href){
    let to='',subject='',body=''; if(!href?.toLowerCase().startsWith('mailto:')) return {to,subject,body};
    const rest=href.slice(7); const [addr,q='']=rest.split('?'); to=decodeURIComponent(addr||'');
    const p=new URLSearchParams(q); subject=p.get('subject')?decodeURIComponent(p.get('subject')):''; body=p.get('body')?decodeURIComponent(p.get('body')):'';
    return {to,subject,body};
  }
  function buildMailto(to,subject,body){
    const qs=new URLSearchParams(); if(subject) qs.set('subject',subject); if(body) qs.set('body',body);
    return `mailto:${encodeURIComponent(to||'')}${qs.toString()?('?'+qs.toString()):''}`;
  }

  /* ===== Image modal ===== */
  let uploadedDataURL=null, insertingImage=false;
  $('imageModalBtn').addEventListener('click', ()=>{
    $('imgUrl').value=''; $('imgAlt').value=''; $('imgWidth').value=''; uploadedDataURL=null; $('imgFile').value='';
    showModal('imageModal');
  });
  $('imgFile').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f){uploadedDataURL=null;return;}
    const rd=new FileReader(); rd.onload=()=>uploadedDataURL=rd.result; rd.readAsDataURL(f);
  });
  $('imageInsertBtn').addEventListener('click', ()=>{
    if(insertingImage) return; insertingImage=true; setTimeout(()=>insertingImage=false,250);
    restoreSelection(); content.focus();
    const src=$('imgUrl').value.trim() || uploadedDataURL || '';
    const alt=$('imgAlt').value.trim(); const w=$('imgWidth').value.trim();
    if(!src){ alert('Provide an image URL or upload a file.'); return; }
    const img=document.createElement('img'); img.src=src; img.alt=alt||''; img.style.maxWidth='100%'; img.loading='lazy'; img.decoding='async';
    if(w && !isNaN(+w)) img.style.width=`${parseInt(w,10)}px`;
    insertNodeAtSelection(img);
    normalizeEditorDOM(content);
    queueSave(); closeModal('imageModal');
  });

  /* ===== Toggle Source / Design ===== */
  $('toggleSource').addEventListener('click', toggleSourceView);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ e.preventDefault(); toggleSourceView(); } });
  function toggleSourceView(){
    if(source.style.display==='block'){
      let html = source.value.trim();
      html = normalizeBRMarkup(html);
      content.innerHTML = html;
      normalizeEditorDOM(content);
      content.style.display='block'; source.style.display='none'; content.focus();
    } else {
      source.value = prettyHTML(content.innerHTML);
      content.style.display='none'; source.style.display='block'; source.focus();
    }
  }
  function prettyHTML(html){
    try{ const tmp=document.createElement('div'); tmp.innerHTML=html; return serialize(tmp,0).trim(); }
    catch{ return html }
  }
  const BLOCKS=new Set(['p','h1','h2','h3','h4','h5','h6','ul','ol','li','blockquote','pre','table','thead','tbody','tr','td','th','hr','div','section','article','nav','header','footer','aside','figure','figcaption']);
  function serialize(node,level){
    let out=''; const indent='  '.repeat(level);
    node.childNodes.forEach(ch=>{
      if(ch.nodeType===3){ const t=ch.textContent.replace(/\s+/g,' ').trim(); if(t) out+=indent+t+'\n'; return; }
      if(ch.nodeType!==1) return;
      const el=ch; const tag=el.tagName.toLowerCase();
      const attrs=[...el.attributes].map(a=>` ${a.name}="${a.value}"`).join('');
      const open=`<${tag}${attrs}>`, close=`</${tag}>`;
      const hasBlock = Array.from(el.children).some(e=>BLOCKS.has(e.tagName.toLowerCase()));
      if(BLOCKS.has(tag) || hasBlock){ out += `${indent}${open}\n${serialize(el,level+1)}${indent}${close}\n`; }
      else{ out += `${indent}${open}${el.innerHTML}${close}\n`; }
    });
    return out;
  }

  /* ===== Copy / Import / Export ===== */
  async function copy(text){
    try{ await navigator.clipboard.writeText(text); flash('Copied HTML'); }
    catch{
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); ta.remove(); flash('Copied HTML');
    }
  }
  $('copyHtmlBtn').addEventListener('click', ()=> copy(prettyHTML(content.innerHTML)));
  $('copyHtmlToolbarBtn').addEventListener('click', ()=> copy(prettyHTML(content.innerHTML)));

  $('importBtn').addEventListener('click', ()=>{
    const i=document.createElement('input'); i.type='file'; i.accept='.html,.htm,text/html';
    i.onchange=async()=>{
      const f=i.files[0]; if(!f) return;
      const txt=await f.text();
      const m=txt.match(/<body[^>]*>([\s\S]*)<\/body>/i);
      content.innerHTML=(m?m[1]:txt).trim();
      normalizeEditorDOM(content);
      queueSave();
    };
    i.click();
  });

  $('exportBtn').addEventListener('click', ()=>{
    const doc=['<!doctype html>','<html>','<head><meta charset="utf-8"><title>'+escapeHtml(titleEl.textContent||'Document')+'</title></head>','<body>',prettyHTML(content.innerHTML),'</body>','</html>'].join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([doc],{type:'text/html;charset=utf-8'}));
    a.download=(titleEl.textContent||'document').trim().replace(/[^\w\-]+/g,'_').slice(0,40)+'.html';
    a.click();
  });

  /* ===== Paste handling: Plain vs Word Sanitized + linkify ===== */
  let pasteMode='plain';
  const pasteModeEl=$('pasteMode'); pasteModeEl?.addEventListener('change', e=> pasteMode=e.target.value);

  content.addEventListener('paste', e=>{
    const html=e.clipboardData?.getData('text/html')||'';
    const text=e.clipboardData?.getData('text/plain')||'';
    e.preventDefault();
    if(pasteMode==='word' && html){
      const cleaned=cleanWordHtmlKeepFootnotesInline(html);
      document.execCommand('insertHTML', false, cleaned);
    } else {
      const linked=linkifyTextToHTML(text);
      document.execCommand('insertHTML', false, linked);
    }
    normalizeEditorDOM(content);
    queueSave();
  });

  function enforceLinkTargets(root){
    root.querySelectorAll('a[href]').forEach(a=>{
      const href=(a.getAttribute('href')||'').trim();
      if(/^https?:/i.test(href)) a.setAttribute('target','_blank');
      else a.removeAttribute('target');
      a.removeAttribute('rel'); a.removeAttribute('style');
    });
  }
  function linkifyTextToHTML(t){
    const esc=s=>s.replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    let out=esc(t);
    out=out.replace(/\bhttps?:\/\/[^\s<>"']+/gi, m=>`<a href="${m}" target="_blank">${esc(m)}</a>`);
    out=out.replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi, m=>`<a href="mailto:${m}">${esc(m)}</a>`);
    return out.replace(/\n/g,'<br>');
  }

  // Word sanitizer (keeps: h1-3, p, strong, em, ul/ol/li, a, sup; converts div->p; preserves footnotes)
  function cleanWordHtmlKeepFootnotesInline(inputHtml){
    const doc=new DOMParser().parseFromString(inputHtml,'text/html'); const body=doc.body;

    // remove comments
    const walker=doc.createTreeWalker(body, NodeFilter.SHOW_COMMENT, null);
    const del=[]; while(walker.nextNode()) del.push(walker.currentNode); del.forEach(n=>n.remove());

    // strip MSO noise & named anchors
    body.querySelectorAll('*').forEach(el=>{
      if(/^Mso/i.test(el.className)) el.removeAttribute('class');
      if(el.hasAttribute('style')){
        const cleaned=(el.getAttribute('style')||'')
          .replace(/\s*mso-[^:]+:[^;]+;?/gi,'')
          .replace(/\s*line-height:[^;]+;?/gi,'')
          .trim();
        if(cleaned) el.setAttribute('style',cleaned); else el.removeAttribute('style');
      }
      el.removeAttribute('id'); el.removeAttribute('lang');
      if(el.tagName==='A' && el.hasAttribute('name') && !el.hasAttribute('href')) unwrap(el);
    });

    // normalize tags: span/font -> unwrap; b->strong; i->em; div->p
    [...body.querySelectorAll('*')].forEach(el=>{
      const t=el.tagName.toLowerCase();
      if(t==='span'||t==='font') unwrap(el);
      if(t==='b'){ replaceTag(el,'strong'); }
      if(t==='i'){ replaceTag(el,'em'); }
      if(t==='div'){ replaceTag(el,'p'); }
    });

    // whitelist + link target
    const ALLOWED=new Set(['h1','h2','h3','p','strong','em','ul','ol','li','a','sup']);
    [...body.querySelectorAll('*')].forEach(el=>{
      const t=el.tagName.toLowerCase();
      if(!ALLOWED.has(t)){ unwrap(el); return; }
      if(t==='a'){
        const href=(el.getAttribute('href')||'').trim();
        if(!/^https?:|^mailto:|^#/i.test(href)){ unwrap(el); return; }
        [...el.attributes].forEach(a=>{ if(a.name!=='href') el.removeAttribute(a.name); });
        if(/^https?:/i.test(href)) el.setAttribute('target','_blank'); // external only
      } else {
        [...el.attributes].forEach(a=> el.removeAttribute(a.name));
      }
    });

    // drop empty p
    body.querySelectorAll('p').forEach(p=>{ if(!p.textContent.trim() && p.children.length===0) p.remove(); });

    // Final normalize in sanitizer scope
    normalizeInlineTags(body);
    body.querySelectorAll('p').forEach(flattenParagraphInline);

    return body.innerHTML.trim();

    function unwrap(el){ while(el.firstChild) el.parentNode.insertBefore(el.firstChild, el); el.remove(); }
    function replaceTag(el,name){ const neo=doc.createElement(name); neo.innerHTML=el.innerHTML; el.replaceWith(neo); }
  }

  // Ctrl/Cmd-click to open links while editing
  content.addEventListener('click', e=>{
    const a=e.target.closest('a'); if(!a || !content.contains(a)) return;
    if(e.metaKey || e.ctrlKey){ e.preventDefault(); window.open(a.href,'_blank'); }
  });

  /* ===== Autosave ===== */
  let timer=null;
  function queueSave(){ clearTimeout(timer); status.textContent='Savingâ€¦'; timer=setTimeout(saveNow,400); }
  function saveNow(){
    try{ localStorage.setItem(DOC_KEY, JSON.stringify({title:titleEl.textContent||'Untitled Document', html:content.innerHTML, ts:Date.now()})); status.textContent='Saved'; }
    catch(e){ status.textContent='Autosave error'; }
  }
  (function restore(){
    try{
      const raw=localStorage.getItem(DOC_KEY);
      if(raw){
        const d=JSON.parse(raw);
        titleEl.textContent=d.title||'Untitled Document';
        content.innerHTML=d.html||'';
        normalizeEditorDOM(content);
      } else {
        // Welcome (single-line <p>)
        content.innerHTML = '<h1>Welcome ðŸ‘‹</h1><p>Use the toolbar to format text, insert <strong>links</strong>, <em>images</em>, and more. Try the Link/Image/Mailto pop-ins.</p>';
        normalizeEditorDOM(content);
      }
    }catch{
      content.innerHTML = '<h1>Welcome ðŸ‘‹</h1><p>Use the toolbar to format text, insert <strong>links</strong>, <em>images</em>, and more. Try the Link/Image/Mailto pop-ins.</p>';
      normalizeEditorDOM(content);
    }
  })();
  content.addEventListener('input', ()=>{ queueSave(); });

  // Notes autosave
  const notes=$('notesArea'); try{ notes.value=localStorage.getItem(NOTES_KEY)||''; }catch{}
  notes.addEventListener('input', ()=>{ try{ localStorage.setItem(NOTES_KEY, notes.value); }catch{} });

  // Shortcuts
  document.addEventListener('keydown', e=>{
    const meta=e.ctrlKey||e.metaKey;
    if(e.key==='Escape'){ e.preventDefault(); $('toggleSource').click(); }
    if(!meta) return;
    const k=e.key.toLowerCase();
    if(['b','i','u'].includes(k)){
      e.preventDefault();
      document.execCommand({b:'bold',i:'italic',u:'underline'}[k], false, null);
      normalizeInlineTags(content);
      normalizeEditorDOM(content);
      queueSave();
    }
    if(k==='k'){ e.preventDefault(); $('linkModalBtn').click(); }
    if(k==='s'){ e.preventDefault(); $('exportBtn').click(); }
  });
})();
</script>
</body>
</html>
